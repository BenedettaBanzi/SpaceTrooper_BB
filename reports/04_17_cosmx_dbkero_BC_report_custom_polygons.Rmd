---
title: "04_17_cosmx_dbkero_BC_report_custom_polygons"
author: "Benedetta Banzi"
date: "2024-04-18"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

<STYLE TYPE="text/css">
<!--
  td{
    font-family: Arial; 
    font-size: 10 pt;
    padding:0px;
    cellpadding="0";
    cellspacing="0"
  }
  th {
    font-family: Arial; 
    font-size: 10 pt;
    height: 20px;
    font-weight: bold;
    text-align: "center";
    background-color: #ccccff;
    padding-left: 15px;
    padding-right: 15px;
  }
  table { 
    border-spacing: 4px;
    border-collapse: collapse;
  }
--->
</STYLE>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Library import

```{r}
library(SpatialExperiment)
library(data.table)
library(scater) # it imports scuttle
library(cowplot)
library(ggplot2)
theme_set(theme_bw())
library(matrixStats)
library(dplyr)
library(tidyr)
library(tibble)
library(arrow)
library(scales)
library(sf)
library(tmap)
library(knitr)
library(grid)
library(ggpointdensity)
library(ggpubr)
library(spdep)
library(ggExtra)
library(terra)
library(DT)
library(e1071)
library(robustbase)
```

Read-in function

```{r}
readCosmxSPE <- function(dirname = dirname, 
                         countmatfpattern = "exprMat_file.csv", 
                         metadatafpattern = "metadata_file.csv", 
                         coord_names = c("CenterX_global_px",
                                         "CenterY_global_px")){
  
  countmat_file <- file.path(dirname, list.files(dirname, countmatfpattern))
  metadata_file <- file.path(dirname, list.files(dirname, metadatafpattern))
  
  # Read in 
  countmat <- data.table::fread(countmat_file)
  metadata <- data.table::fread(metadata_file)
  
  # Count matrix 
  counts <- merge(countmat, metadata[, c("fov", "cell_ID")])
  counts <- subset(counts, select = -c(fov, cell_ID))
  cell_codes <- rownames(counts)
  features <- colnames(counts)
  counts <- t(counts)
  
  rownames(counts) <- features
  colnames(counts) <- cell_codes
  
  # rowData (does not exist)
  
  # colData
  metadata <- metadata[order(metadata$cell_ID), ]
  colData <- merge(metadata, countmat[, c("fov", "cell_ID")])
  
  spe <- SpatialExperiment::SpatialExperiment(
    assays = list(counts = counts),
    # rowData = rowData,
    colData = colData,
    spatialCoordsNames = coord_names
  )
  
  return(spe)
}
```

Setting directories

```{r}
dirname <- "/NAS06/work/Spatial_omics/DBKero/CosMx_Breast/CosMX_data_Case2"
count_pattern <- "Run5810_Case2_exprMat_file.csv"
meta_pattern <- "Run5810_Case2_metadata_file.csv"
sample_name <- "CosMx_DBKero_BC"
```

# CosMx dataset preprocessing {.tabset .tabset-fade .tabset-pills}

Data import and SpatialExperiment object creation

```{r}
spe <- readCosmxSPE(dirname = dirname, countmatfpattern = count_pattern, metadatafpattern = meta_pattern)
spe <- scuttle::addPerCellQC(spe, subsets=list(NegProb = grep("^NegPrb", rownames(spe))))
names(colData(spe)@listData)
spe$control_counts <- spe$subsets_NegProb_sum
spe$control_detected <- spe$subsets_NegProb_detected
```

Dataset dimensions

```{r}
dim(spe)
```

Adding variables

```{r, class.source = 'fold-show'}
fov_size <- 4225

names(colData(spe))[names(colData(spe)) == "cell_ID"] <- "cell_id"

spe$id_fov <- paste(spe$cell_id, spe$fov, sep = "_")

# Importing global coordinates from spatialCoords slot since they are not available in colData
spe$CenterX_global_px <- spatialCoords(spe)[,1]
spe$CenterY_global_px <- spatialCoords(spe)[,2]

# Converting global coordinates to um 
spe$CenterX_global_um <- spe$CenterX_global_px*0.12
spe$CenterY_global_um <- spe$CenterY_global_px*0.12 

# Logged total counts
spe$logtot <- log10(spe$total)

# Converting area in um
spe$um_area <- spe$Area*0.0144

# Keeping only target counts by subtracting counts referred to control probes
spe$target_counts <- spe$total - spe$control_counts

# Target area ratio
spe$target_area_ratio <- spe$target_counts/spe$um_area

# Logged width/height ratio so there are no holes in the distribution in the middle and also negative values can be appreciated
spe$log2_AspectRatio <- log2(spe$AspectRatio)

# Keeping only detected features by subtracting negative control probes
spe$target_detected <- spe$detected - spe$control_detected

# Proportion between counts referred only to target probes and detected features
spe$tot_det_ratio <- spe$target_counts/spe$target_detected

# Control probe counts/total counts
ctrl_total_ratio <- spe$control_counts/spe$total
ctrl_total_ratio <- replace_na(ctrl_total_ratio, 0)
spe$ctrl_total_ratio <- ctrl_total_ratio
```

Loading custom polygon file and setting the correct format as sf object

Creating custom polygon file to add 

```{r}
fov_pattern <- "Run5810_Case2_fov_positions_file.csv"
fovpos_file <- file.path(dirname, list.files(dirname, fov_pattern))

metadata <- data.frame(colData(spe))
fov_positions <- data.table::fread(fovpos_file, header = T)
fov_positions <- fov_positions[fov_positions$fov %in% unique(metadata$fov),]
fov_positions <- fov_positions[order(fov_positions$fov), ]

tif_list <- list()
for(i in 1:length(table(metadata$fov))){
  prefix <- ifelse(i < 10, "F00", "F0")
  tif_list[[i]] <- file.path(dirname, "CellLabels", paste0("CellLabels_", prefix, i, ".tif"))
}

terra_list <- list()
terra_list <- lapply(tif_list, function(x){
  terra_rast <- terra::rast(x)
  terra_polygon <- terra::as.polygons(terra_rast, value = TRUE)
  terra_polygon <- terra::fillHoles(terra_polygon)
  names(terra_polygon) <- c("cell_id")
  terra_polygon$fov <- rep(which(tif_list == x), dim(terra_polygon)[1])
  valid_index <- terra::is.valid(terra_polygon)
  terra_polygon <- terra_polygon[valid_index]
  terra_polygon <- terra::flip(terra_polygon, direction = "vertical")
        shift_horizontal_step <- 0
        shift_vertical_step <- dim(terra_rast)[1]
        terra_polygon = terra::shift(terra_polygon,
                                     dx = shift_horizontal_step,
                                     dy = shift_vertical_step)
  if (terra_polygon$cell_id[1]==0){
    terra_polygon <- terra::subset(terra_polygon, terra_polygon$cell_id!=0)}
  terra_list[[x]] <- terra_polygon      
})        

spat_obj <- NULL
for(k in 1:length(terra_list)){        
  dt_geom <- as.data.table(terra::geom(terra_list[[k]]))
  dt_values <- as.data.table(terra::values(terra_list[[k]]))
  dt_values[, `:=`(geom, 1:nrow(dt_values))]
  spatVec_dt <- merge.data.table(dt_geom, dt_values, by = "geom")
  spatVec_dt <- spatVec_dt[,c("cell_id","x","y")]
  names(spatVec_dt) <- c("cell_id","x_local_px", "y_local_px")
  # shift coordinates base on the underlying tissue geometry
  spatVec_dt$x_global_px <- spatVec_dt$x_local_px + fov_positions$x_global_px[k]
  spatVec_dt$y_global_px <- spatVec_dt$y_local_px + fov_positions$y_global_px[k]
  # add a column with the fov and transform into a data.table
  spatVec_dt <- data.frame(fov = fov_positions[k,"fov"], as.data.frame(spatVec_dt))
  spat_obj <- rbind(spat_obj, spatVec_dt)
}


sf_global <- st_as_sf(spat_obj, coords = c("x_global_px", "y_global_px"))

polygons_whole_custom <- sf_global %>%
  group_by(fov, cell_id) %>%
  summarize(geometry = st_combine(geometry))#st_combine = combine several feature geometries into one, without unioning or resolving internal boundaries

polygons_whole_custom <- st_cast(polygons_whole_custom, "POLYGON")  

if(attr(table(rownames(polygons_whole_custom) == colnames(spe)), "dimnames")[[1]][1] == FALSE){
  polygons_whole_custom <- polygons_whole_custom[order(as.numeric(rownames(polygons_whole_custom))), ]
  spe <- spe[, order(as.numeric(colnames(spe)))]
  spe <- spe[, colnames(spe) %in% rownames(polygons_whole_custom)]
}

spe$polygons_whole_custom <- polygons_whole_custom
spe$polygons_whole_custom$id_fov <- paste(spe$polygons_whole_custom$cell_id, spe$polygons_whole_custom$fov, sep = "_")
```

Checking if the computed polygons are valid and removing elements that could result in geometry errors (Voyager)

```{r}
valid_poly <- st_is_valid(spe$polygons_whole_custom)
table(valid_poly)
```

```{r}
polygons_whole_custom <- st_buffer(polygons_whole_custom, dist = 0)
table(valid_poly)
```

Checking if all the geometries are polygons

```{r}
table(st_geometry_type(polygons_whole_custom$geometry))
```

Subsetting to remove non-polygons

```{r}
cellids <- c() 
for(i in 1:dim(polygons_whole_custom)[1]){
	cellids[i] <- attr(polygons_whole_custom$geometry[[i]], "class")[2]
	cellids[i] <- cellids[i] == "MULTIPOLYGON"
	
}

spe <- spe[, cellids == FALSE]
table(st_geometry_type(spe$polygons_whole_custom))
```

```{r}
spe$custom_area <- st_area(spe$polygons_whole_custom)
spe$um_area <- spe$custom_area*0.0144
```

# Large-scale to small-scale {.tabset .tabset-fade .tabset-pills}

Approaching dataset preprocessing starting from global-scale, then fov-focused exploratory analysis

## Global sample map

To view the spatial organization of both the sample as it is and FOVs

```{r, out.width="600%", out.height="150%"}
# image theme
global_map_theme <- function(back.color="black",back.border=NA,title.col="white") {
  theme(aspect.ratio = 1,
        panel.border = element_blank(),
        legend.key = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        panel.grid = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "transparent",colour = NA),
        plot.title = element_text(color = title.col,hjust = 0.5,face = "bold"),
        plot.background = element_rect(fill = "transparent",colour = back.border))
}

ggplot() + 
  geom_point(data = metadata, mapping = aes(x = CenterX_global_px, y = CenterY_global_px), colour = "darkmagenta", fill="darkmagenta", size = 0.05, alpha = 0.2) +
  annotate("rect", xmin = fov_positions$x_global_px, 
           xmax = fov_positions$x_global_px + fov_size, 
           ymin = fov_positions$y_global_px, 
           ymax = fov_positions$y_global_px + fov_size,
           alpha = .2, color = "black",linewidth = 0.2) +
  geom_text(aes(x = fov_positions$x_global_px+fov_size/2,
                y = fov_positions$y_global_px+fov_size/2,
                label = fov_positions$fov), color="black") +
  ggtitle(sample_name) + 
  global_map_theme(back.color = "white", back.border = "white", title.col = "black")
```


## Global polygon map

```{r, out.width="600%", out.height="900%"}
tm_shape(spe$polygons_whole_custom) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = sample_name,
            main.title.size = 0.5,
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

## Global feature maps

To spot areas with anomalous feature values and spatial patterns on a global scale

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", colour_by = "total", point_size = 0.1) + ggtitle("Total counts per cell") + theme(aspect.ratio = 1)
```

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", colour_by = "logtot", point_size = 0.1) + ggtitle("Log-total counts per cell") + theme(aspect.ratio = 1)
```

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", colour_by = "detected", point_size = 0.1) + ggtitle("Detected features per cell") + theme(aspect.ratio = 1)
```

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", colour_by = "um_area", point_size = 0.1) + ggtitle("Area in μm per cell") + theme(aspect.ratio = 1)
```

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", colour_by = "log2_AspectRatio", point_size = 0.1) + ggtitle("Logged width/height ratio per cell") + theme(aspect.ratio = 1)
```

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", colour_by = "tot_det_ratio", point_size = 0.1) + ggtitle("Target counts/detected features ratio per cell") + theme(aspect.ratio = 1)
```

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", order_by = "control_counts", colour_by = "control_counts", point_size = 0.1) +
  scale_color_gradient(low = "white", high = "red", name = "control_counts") + ggtitle("Negative control probe counts per cell") +
  theme(aspect.ratio = 1,
        panel.background = element_rect(fill = "black",color = NA),
        plot.background = element_rect(fill = "black",color = NA),
        axis.title.x = element_text(color = "white"),
        axis.title.y = element_text(color = "white"),
        axis.ticks = element_line(color = "white"),
        axis.text.y = element_text(color = "white"),
        axis.text.x = element_text(color = "white"),
        axis.line = element_line(color = "white"),
        legend.title = element_text(color = "white"),
        legend.text = element_text(color = "white"),
        plot.title = element_text(color = "white"))
```

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", colour_by = "ctrl_total_ratio", point_size = 0.1) + ggtitle("Control counts/total counts ratio per cell") + theme(aspect.ratio = 1)
```

# Feature histograms 

To check feature distribution before highlighting where extreme values are located in the global sample map

```{r}
variables <- c("total", "detected", "logtot", "um_area", "log2_AspectRatio", "tot_det_ratio", "control_counts", "Mean.DAPI", "ctrl_total_ratio")
for (var in 1:length(variables)){
  n <- grep(paste0("^", variables[var], "$"), colnames(spe@colData))
  histo_var <- names(colData(spe))[n]
  p <- ggplot(data = data.frame(colData(spe))) +
    geom_histogram(aes(x = .data[[histo_var]]), fill = "#69b3a2") +
    ggtitle(paste0(histo_var))
  print(p)
}  
```

# First cell skimming with absolute values {.tabset .tabset-fade .tabset-pills}

Coarse-grain cell filtering to remove gross segmentation errors.

## Total counts

```{r}
summary(spe$total)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$total)
```

```{r, out.width="150%", out.height="150%"}
boxplot(spe$total)
```

```{r, out.width="150%", out.height="150%"}
threshold <- 0
spe$flagged_0total <- as.factor(ifelse(colData(spe)$total == 0, TRUE, FALSE))
spe$polygons_whole_custom$flagged_0total <- ifelse(spe$flagged_0total == TRUE, "red", "grey80")

tm_shape(spe$polygons_whole_custom) + 
  tm_fill(col = "flagged_0total") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Cells having 0 total counts", "\nFlagged cells = ",
                                table(colData(spe)$flagged_0total)["TRUE"], " out of ", dim(spe)[2], ", ",
                                round(table(colData(spe)$flagged_0total)["TRUE"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

```{r}
tot0_spe <- spe[,spe$flagged_0total == FALSE]
dim(tot0_spe)
```


# First cell skimming with scuttle::isOutlier (Hampel filter) {.tabset .tabset-fade .tabset-pills}

Introducing scuttle::isOutlier function to move to a different filter beyond threshold
Outliers are defined when their value is higher or lower than the median, plus or minus 3 median absolute deviations (MAD) respectively.
However, when using MAD a symmetric distribution is assumed

## Control count / total counts

```{r}
summary(spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
boxplot(spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
spe$outlier_ctrl_tot <- scuttle::isOutlier(spe$ctrl_total_ratio, type = "higher", nmad = 5)
spe$polygons_whole_custom$outlier_ctrl_tot <- ifelse(spe$outlier_ctrl_tot == TRUE, "red", "grey80")

tm_shape(spe$polygons_whole_custom) + 
  tm_fill(col= "outlier_ctrl_tot") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Outlier cells for control / total counts ratio", 
                                "\n lower thr. = " , round(attr(spe$outlier_ctrl_tot,"thresholds")["lower"], 2), ", higher thr. = ",
                                round(attr(spe$outlier_ctrl_tot,"thresholds")["higher"], 2),
                                "\nFlagged cells = ",
                                table(colData(spe)$outlier_ctrl_tot)["TRUE"], " out of ", dim(spe)[2], ", ",
                                round(table(colData(spe)$outlier_ctrl_tot)["TRUE"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

```

```{r}
ctrltotratio_spe <- spe[,spe$outlier_ctrl_tot == FALSE]
summary(ctrltotratio_spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
hist(ctrltotratio_spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
boxplot(ctrltotratio_spe$ctrl_total_ratio)
```

# First cell skimming with skewness adjustment to boxplot {.tabset .tabset-fade .tabset-pills}

Introducing medcouple (MC) from Hubert, M. and Vandervieren, E. (2008). Boxplot whiskers are defined as:
1st quartile - 1.5 * hl(MC) * IQR 
3rd quartile + 1.5 * hu(MC) * IQR
If MC >= 0, hl = exp(-4 * MC), hu = exp(3 * MC) 
If MC < 0, hl = exp(-3 * MC), hu = exp(4 * MC)

```{r}
spe$polygons_whole_custom$control_counts <- spe$control_counts
spe$polygons_whole_custom$ctrl_total_ratio <- spe$ctrl_total_ratio
spe$polygons_whole_custom$um_area <- spe$um_area
spe$polygons_whole_custom$log2_AspectRatio <- spe$log2_AspectRatio
spe$polygons_whole_custom$Mean.DAPI <- spe$Mean.DAPI
```


## Um area

```{r}
summary(spe$um_area)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$um_area)
```

Skewness

```{r}
skewness(spe$um_area)[1]
```

Medcouple

```{r}
mc(spe$um_area)[1]
```

How many outliers were found?

```{r}
names(spe$um_area) <- colnames(spe)
out <- adjbox(spe$um_area)
length(out$out)
```

Distribution of outlier values

```{r}
summary(out$out)
```

```{r, out.width="150%", out.height="150%"}
outlier_color <- colnames(spe)
for(i in 1:out$n){
  outlier_color[i] <- ifelse(outlier_color[i] %in% names(out$out), "red", "grey80")
}

spe$polygons_whole_custom$umarea_outlier <- outlier_color

tm_shape(spe$polygons_whole_custom) + 
  tm_fill(col= "umarea_outlier") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Outlier cells for um area", 
                                "\n fence = " , round(out$fence, 2),
                                "\nFlagged cells = ",
                                table(spe$polygons_whole_custom$umarea_outlier)["red"], " out of ", dim(spe)[2], ", ",
                                round(table(spe$polygons_whole_custom$umarea_outlier)["red"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

```{r}
area_poly <- spe$polygons_whole_custom[spe$polygons_whole_custom$umarea_outlier == "grey80",]
hist(area_poly$um_area)
```

```{r, out.width="150%", out.height="150%"}
boxplot(area_poly$um_area)
```

```{r}
summary(area_poly$um_area)
```

## Mean DAPI signal

```{r}
summary(spe$Mean.DAPI)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$Mean.DAPI)
```

Skewness

```{r}
skewness(spe$Mean.DAPI)[1]
```

Medcouple

```{r}
mc(spe$Mean.DAPI)[1]
```

How many outliers were found?

```{r}
names(spe$Mean.DAPI) <- colnames(spe)
out <- adjbox(spe$Mean.DAPI)
length(out$out)
```

Distribution of outlier values

```{r}
summary(out$out)
```

```{r, out.width="150%", out.height="150%"}
outlier_color <- colnames(spe)
for(i in 1:out$n)
  outlier_color[i] <- ifelse(outlier_color[i] %in% names(out$out), "red", "grey80")

spe$polygons_whole_custom$dapi_outlier <- outlier_color

tm_shape(spe$polygons_whole_custom) + 
  tm_fill(col= "dapi_outlier") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Outlier cells for dapi", 
                                "\n fence = " , round(out$fence, 2),
                                "\nFlagged cells = ",
                                table(spe$polygons_whole_custom$dapi_outlier)["red"], " out of ", dim(spe)[2], ", ",
                                round(table(spe$polygons_whole_custom$dapi_outlier)["red"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

```{r}
table(spe$outlier_negprob, spe$outlier_umarea, dnn = c("outlier_negprob", "outlier_umarea"))
```

```{r}
dapi_poly <- spe$polygons_whole_custom[spe$polygons_whole_custom$dapi_outlier == "grey80",]
hist(dapi_poly$Mean.DAPI)
```

```{r, out.width="150%", out.height="150%"}
boxplot(dapi_poly$Mean.DAPI)
```

```{r}
summary(dapi_poly$Mean.DAPI)
```


# Flag score development 

## Exploratory scatterplots {.tabset .tabset-fade .tabset-pills}

### Total counts ~ logged width/height ratio

```{r, out.width="150%", out.height="150%"}
cell_df <- data.frame(colData(spe))

p <- ggplot(data = cell_df) +
  geom_pointdensity(aes(x = log2_AspectRatio, y = total)) +
  scale_color_viridis_c() +
  theme(legend.position = "none",
        plot.margin = margin())

ggMarginal(p, type = "density", color = "#ccccff", fill = "#ccccff") 
```

### Detected features ~ logged width/height ratio

```{r, out.width="150%", out.height="150%"}
p <- ggplot(data = cell_df) +
  geom_pointdensity(aes(x = log2_AspectRatio, y = detected)) +
  scale_color_viridis_c() +
  theme(legend.position = "none",
        plot.margin = margin())

ggMarginal(p, type = "density", color = "#ccccff", fill = "#ccccff") 
```

### Total counts ~ area in um

```{r, out.width="150%", out.height="150%"}
p <- ggplot(data = cell_df) +
  geom_pointdensity(aes(x = um_area, y = total)) +
  scale_color_viridis_c() +
  theme(legend.position = "none",
        plot.margin = margin())

ggMarginal(p, type = "density", color = "#ccccff", fill = "#ccccff") 
```

### Logged width/height ratio ~ negative control probe counts

```{r, out.width="150%", out.height="150%"}
p <- ggplot(data = cell_df) +
  geom_pointdensity(aes(x = control_counts, y = log2_AspectRatio)) +
  scale_color_viridis_c() +
  theme(legend.position = "none",
        plot.margin = margin())

ggMarginal(p, type = "density", color = "#ccccff", fill = "#ccccff") 
```

### Logged width/height ratio ~ local coordinates on X axis in px

```{r, out.width="150%", out.height="150%"}
p <- ggplot(data = cell_df) +
  geom_pointdensity(aes(x = CenterX_local_px, y = log2_AspectRatio)) +
  scale_color_viridis_c() +
  theme(legend.position = "none",
        plot.margin = margin())

ggMarginal(p, type = "density", color = "#ccccff", fill = "#ccccff") 
```

### Logged width/height ratio ~ local coordinates on X axis in px

```{r, out.width="150%", out.height="150%"}
p <- ggplot(data = cell_df) +
  geom_pointdensity(aes(x = CenterY_local_px, y = log2_AspectRatio)) +
  scale_color_viridis_c() +
  theme(legend.position = "none",
        plot.margin = margin())

ggMarginal(p, type = "density", color = "#ccccff", fill = "#ccccff") 
```

### Control counts ~ um area

```{r, out.width="150%", out.height="150%"}
p <- ggplot(data = cell_df) +
  geom_pointdensity(aes(x = um_area, y = control_counts)) +
  scale_color_viridis_c() +
  theme(legend.position = "none",
        plot.margin = margin())

ggMarginal(p, type = "density", color = "#ccccff", fill = "#ccccff") 
```

### DAPI ~ um area

```{r, out.width="150%", out.height="150%"}
p <- ggplot(data = cell_df) +
  geom_pointdensity(aes(x = um_area, y = Mean.DAPI)) +
  scale_color_viridis_c() +
  theme(legend.position = "none",
        plot.margin = margin())

ggMarginal(p, type = "density", color = "#ccccff", fill = "#ccccff") 
```

## Flag score formula

```{r class.source = 'fold-show'}
spe$flag_score_hw <- 1/(1 + exp(-0.3*spe$target_counts/spe$um_area + 0.8*abs(spe$log2_AspectRatio)))
summary(spe$flag_score_hw)
plot(spe$flag_score_hw)
```

```{r}
hist(spe$flag_score_hw)
```

Adding variables to polygon sf object

```{r, out.width="150%", out.height="150%"}
spe$polygons_whole_custom$total <- spe$total
spe$polygons_whole_custom$target_counts <- spe$target_counts
spe$polygons_whole_custom$um_area <- spe$um_area
spe$polygons_whole_custom$log2_AspectRatio <- spe$log2_AspectRatio
spe$polygons_whole_custom$flag_score_hw <- spe$flag_score_hw
spe$polygons_whole_custom$control_counts <- spe$control_counts
spe$polygons_whole_custom$target_area_ratio <- spe$target_area_ratio
spe$polygons_whole_custom$Mean.DAPI <- spe$Mean.DAPI
```

## Flag score gradient map

```{r, out.width="150%", out.height="150%"}
tm_shape(spe$polygons_whole_custom) + 
  tm_fill(col = "flag_score_hw") +
  tm_layout(legend.outside = TRUE)
```

# Flag threshold map with AspectRatio in flag score formula and scuttle outliers {.tabset .tabset-fade .tabset-pills}

```{r}
spe$outlier_target <- scuttle::isOutlier(spe$target_counts, type = "lower", nmad = 2)
spe$polygons_whole_custom$outlier_target <- ifelse(spe$outlier_target == TRUE, "red", "grey80")

spe$outlier_targetarea <- scuttle::isOutlier(spe$target_area_ratio, type = "lower", nmad = 2)
spe$polygons_whole_custom$outlier_targetarea <- ifelse(spe$outlier_targetarea == TRUE, "red", "grey80")

spe$outlier_umarea <- scuttle::isOutlier(colData(spe)$um_area, type = "both", nmad = 2)
spe$polygons_whole_custom$outlier_umarea <- ifelse(spe$outlier_umarea == TRUE, "red", "grey80")

spe$outlier_loghw <- scuttle::isOutlier(spe$log2_AspectRatio, type = "both", nmad = 2)
spe$polygons_whole_custom$outlier_loghw<- ifelse(spe$outlier_loghw == TRUE, "red", "grey80")

spe$outlier_flagscorehw <- scuttle::isOutlier(spe$flag_score_hw, type = "lower", nmad = 2)
spe$polygons_whole_custom$outlier_flagscorehw <- ifelse(spe$outlier_flagscorehw == TRUE, "red", "grey80")

spe$outlier_dapi <- scuttle::isOutlier(spe$Mean.DAPI, type = "both", nmad = 2)
spe$polygons_whole_custom$outlier_dapi <- ifelse(spe$outlier_dapi == TRUE, "red", "grey80")
```

```{r, out.width="300%", out.height="900%"}
p1 <- tm_shape(spe$polygons_whole_custom) + 
  tm_fill(col= "outlier_flagscorehw", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Flag score outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p2 <- tm_shape(spe$polygons_whole_custom) + 
  tm_fill(col= "outlier_target", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p3 <- tm_shape(spe$polygons_whole_custom) + 
  tm_fill(col= "outlier_targetarea", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts/cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p4 <- tm_shape(spe$polygons_whole_custom) + 
  tm_fill(col= "outlier_umarea", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p5 <- tm_shape(spe$polygons_whole_custom) + 
  tm_fill(col= "outlier_loghw", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Logged AspectRatio outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p6 <- tm_shape(spe$polygons_whole_custom) + 
  tm_fill(col= "outlier_dapi", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "DAPI outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))


tmap_arrange(p1, p2, p3, p4, p5, p6, ncol = 2)
```

## Flagged cell stats

```{r, out.width="150%", out.height="150%"}

out_fence <- c(paste(round(attr(spe$outlier_flagscorehw,"thresholds")["lower"], 2), round(attr(spe$outlier_flagscorehw,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_target,"thresholds")["lower"], 2), round(attr(spe$outlier_target,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_targetarea,"thresholds")["lower"], 2), round(attr(spe$outlier_targetarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_umarea,"thresholds")["lower"], 2), round(attr(spe$outlier_umarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_loghw,"thresholds")["lower"], 2), round(attr(spe$outlier_loghw,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_dapi,"thresholds")["lower"], 2), round(attr(spe$outlier_dapi,"thresholds")["higher"], 2)))

flagged_cells <- c(sum(spe$polygons_whole_custom$outlier_flagscorehw=="red", na.rm = T),
                   sum(spe$polygons_whole_custom$outlier_target=="red", na.rm = T),
                   sum(spe$polygons_whole_custom$outlier_targetarea=="red", na.rm = T),
                   sum(spe$polygons_whole_custom$outlier_umarea=="red",na.rm = T),
                   sum(spe$polygons_whole_custom$outlier_loghw=="red",na.rm = T),
                   sum(spe$polygons_whole_custom$outlier_dapi=="red",na.rm = T))

unflagged_cells <- c(sum(spe$polygons_whole_custom$outlier_flagscorehw=="grey80", na.rm = T),
                   sum(spe$polygons_whole_custom$outlier_target=="grey80", na.rm = T),
                   sum(spe$polygons_whole_custom$outlier_targetarea=="grey80", na.rm = T),
                   sum(spe$polygons_whole_custom$outlier_umarea=="grey80",na.rm = T),
                   sum(spe$polygons_whole_custom$outlier_loghw=="grey80",na.rm = T),
                   sum(spe$polygons_whole_custom$outlier_dapi=="grey80",na.rm = T))

percent_flagged <- round(flagged_cells/dim(spe$polygons_whole_custom)[1]*100, 2)

poly <- data.frame(out_fence = out_fence, unflagged_cells = unflagged_cells, flagged_cells = flagged_cells, percent_flagged = percent_flagged, row.names = c("Flag score", "Target counts", "Target counts/cell area", "Cell area in um", "Logged aspect ratio", "DAPI signal"))

kable(poly, format = "html", col.names = c("Outlier thresholds", "Unflagged cells", "Flagged cells", "% flagged cells"), align = "c", caption = paste0("<center>Flagged cells by different metrics, total cells in whole sample: ", dim(spe$polygons_whole_custom)[1], ", flagged cells in whole sample: ", sum(spe$polygons_whole_custom$outlier_flagscorehw=="red"), "</center>"), padding = 1L)
```
#
#

## Big flag threshold map 

```{r, out.width="150%", out.height="150%"}
plot_list <- list(p1, p2, p3, p4, p5, p6)

for(i in 1:length(plot_list)){
  print(plot_list[[i]])
}
```


# Creating sf using local coordinates for geometry

```{r}
sf_local <- st_as_sf(spat_obj, coords = c("x_local_px", "y_local_px"))
names(sf_local)[names(sf_local) == "cellID"] <- "cell_id"

polygons <- sf_local %>%
  group_by(fov, cell_id) %>%
  summarize(geometry = st_combine(geometry))#st_combine = combine several feature geometries into one, without unioning or resolving internal boundaries

polygons <- st_cast(polygons, "POLYGON")

polygons$id_fov <- paste(polygons$cell_id, polygons$fov, sep = "_") 

if(attr(table(rownames(polygons) == colnames(spe)), "dimnames")[[1]][1] == FALSE){
  polygons <- polygons[order(as.numeric(rownames(polygons))), ]
  spe <- spe[, order(as.numeric(colnames(spe)))]
  polygons <- polygons[polygons$id_fov %in% spe$id_fov, ]
}
```

```{r}
valid_poly <- st_is_valid(polygons)
table(valid_poly)
```

```{r}
spe$polygons <- polygons
```

```{r}
table(st_geometry_type(spe$polygons$geometry))
```

```{r}
spe$polygons$total <- spe$total
spe$polygons$target_counts <- spe$target_counts
spe$polygons$um_area <- spe$um_area
spe$polygons$log2_AspectRatio <- spe$log2_AspectRatio
spe$polygons$flag_score_hw <- spe$flag_score_hw
spe$polygons$control_counts <- spe$control_counts
spe$polygons$target_area_ratio <- spe$target_area_ratio
spe$polygons$Mean.DAPI <- spe$Mean.DAPI
```

```{r}
spe$polygons$outlier_target <- ifelse(spe$outlier_target == TRUE, "red", "white")

spe$polygons$outlier_targetarea <- ifelse(spe$outlier_targetarea == TRUE, "red", "white")

spe$polygons$outlier_umarea <- ifelse(spe$outlier_umarea == TRUE, "red", "white")

spe$polygons$outlier_loghw <- ifelse(spe$outlier_loghw == TRUE, "red", "white")

spe$polygons$outlier_flagscorehw <- ifelse(spe$outlier_flagscorehw== TRUE, "red", "white")

spe$polygons$outlier_dapi <- ifelse(spe$outlier_dapi == TRUE, "red", "white")
```

# Fov 1 {.tabset .tabset-fade .tabset-pills}

```{r, out.width="150%", out.height="150%"}
polygons1 <- filter(spe$polygons, fov==1)

tm_shape(polygons1) + 
  tm_fill(col= "flag_score_hw", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE)

```

```{r, out.width="300%", out.height="900%"}
p1 <- tm_shape(polygons1) + 
  tm_fill(col= "outlier_flagscorehw", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Flag score outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p2 <- tm_shape(polygons1) + 
  tm_fill(col= "outlier_target", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p3 <- tm_shape(polygons1) + 
  tm_fill(col= "outlier_targetarea", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts/cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p4 <- tm_shape(polygons1) + 
  tm_fill(col= "outlier_umarea", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p5 <- tm_shape(polygons1) + 
  tm_fill(col= "outlier_loghw", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Logged AspectRatio outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p6 <- tm_shape(polygons1) + 
  tm_fill(col= "outlier_dapi", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "DAPI outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))


tmap_arrange(p1, p2, p3, p4, p5, p6, ncol = 2)
```

## Flagged cell stats

```{r, out.width="150%", out.height="150%"}

out_fence <- c(paste(round(attr(spe$outlier_flagscorehw,"thresholds")["lower"], 2), round(attr(spe$outlier_flagscorehw,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_target,"thresholds")["lower"], 2), round(attr(spe$outlier_target,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_targetarea,"thresholds")["lower"], 2), round(attr(spe$outlier_targetarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_umarea,"thresholds")["lower"], 2), round(attr(spe$outlier_umarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_loghw,"thresholds")["lower"], 2), round(attr(spe$outlier_loghw,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_dapi,"thresholds")["lower"], 2), round(attr(spe$outlier_dapi,"thresholds")["higher"], 2)))

flagged_cells <- c(sum(polygons1$outlier_flagscorehw=="red", na.rm = T),
                   sum(polygons1$outlier_target=="red", na.rm = T),
                   sum(polygons1$outlier_targetarea=="red", na.rm = T),
                   sum(polygons1$outlier_umarea=="red",na.rm = T),
                   sum(polygons1$outlier_loghw=="red",na.rm = T),
                   sum(polygons1$outlier_dapi=="red",na.rm = T))

unflagged_cells <- c(sum(polygons1$outlier_flagscorehw=="white", na.rm = T),
                   sum(polygons1$outlier_target=="white", na.rm = T),
                   sum(polygons1$outlier_targetarea=="white", na.rm = T),
                   sum(polygons1$outlier_umarea=="white",na.rm = T),
                   sum(polygons1$outlier_loghw=="white",na.rm = T),
                   sum(polygons1$outlier_dapi=="white",na.rm = T))

percent_flagged <- round(flagged_cells/dim(polygons1)[1]*100, 2)

poly1 <- data.frame(out_fence = out_fence, unflagged_cells = unflagged_cells, flagged_cells = flagged_cells, percent_flagged = percent_flagged, row.names = c("Flag score", "Target counts", "Target counts/cell area", "Cell area in um", "Logged aspect ratio", "Mean DAPI signal"))

kable(poly1, format = "html", col.names = c("Outlier thresholds", "Unflagged cells", "Flagged cells", "% flagged cells"), align = "c", caption = paste0("<center>Flagged cells by different metrics, total cells in whole sample: ", dim(spe$polygons_whole_custom)[1], ", flagged cells in whole sample: ", sum(spe$polygons_whole_custom$outlier_flagscorehw=="red"), " , total cells in mock fov: ", dim(polygons1)[1], "</center>"), padding = 1L)
```
#
#

## Big flag threshold map 

```{r, out.width="150%", out.height="150%"}
plot_list <- list(p1, p2, p3, p4, p5, p6)

for(i in 1:length(plot_list)){
  print(plot_list[[i]])
}
```


# Fov 21 {.tabset .tabset-fade .tabset-pills}

```{r, out.width="150%", out.height="150%"}
polygons21 <- filter(spe$polygons, fov == 21) 

tm_shape(polygons21) + 
  tm_fill(col= "flag_score_hw", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE)
```

```{r, out.width="300%", out.height="900%"}
p1 <- tm_shape(polygons21) + 
  tm_fill(col= "outlier_flagscorehw", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Flag score outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p2 <- tm_shape(polygons21) + 
  tm_fill(col= "outlier_target", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p3 <- tm_shape(polygons21) + 
  tm_fill(col= "outlier_targetarea", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts/cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p4 <- tm_shape(polygons21) + 
  tm_fill(col= "outlier_umarea", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p5 <- tm_shape(polygons21) + 
  tm_fill(col= "outlier_loghw", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Logged AspectRatio outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p6 <- tm_shape(polygons21) + 
  tm_fill(col= "outlier_dapi", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "DAPI outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))


tmap_arrange(p1, p2, p3, p4, p5, p6, ncol = 2)
```

## Flagged cell stats

```{r, out.width="150%", out.height="150%"}

out_fence <- c(paste(round(attr(spe$outlier_flagscorehw,"thresholds")["lower"], 2), round(attr(spe$outlier_flagscorehw,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_target,"thresholds")["lower"], 2), round(attr(spe$outlier_target,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_targetarea,"thresholds")["lower"], 2), round(attr(spe$outlier_targetarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_umarea,"thresholds")["lower"], 2), round(attr(spe$outlier_umarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_flagscorehw,"thresholds")["lower"], 2), round(attr(spe$outlier_flagscorehw,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_dapi,"thresholds")["lower"], 2), round(attr(spe$outlier_dapi,"thresholds")["higher"], 2)))

flagged_cells <- c(sum(polygons21$outlier_flagscorehw=="red", na.rm = T),
                   sum(polygons21$outlier_target=="red", na.rm = T),
                   sum(polygons21$outlier_targetarea=="red", na.rm = T),
                   sum(polygons21$outlier_umarea=="red",na.rm = T),
                   sum(polygons21$outlier_loghw=="red",na.rm = T),
                   sum(polygons21$outlier_dapi=="red",na.rm = T))

unflagged_cells <- c(sum(polygons21$outlier_flagscorehw=="white", na.rm = T),
                   sum(polygons21$outlier_target=="white", na.rm = T),
                   sum(polygons21$outlier_targetarea=="white", na.rm = T),
                   sum(polygons21$outlier_umarea=="white",na.rm = T),
                   sum(polygons21$outlier_loghw=="white",na.rm = T),
                   sum(polygons21$outlier_dapi=="white",na.rm = T))

percent_flagged <- round(flagged_cells/dim(polygons21)[1]*100, 2)

poly21 <- data.frame(out_fence = out_fence, unflagged_cells = unflagged_cells, flagged_cells = flagged_cells, percent_flagged = percent_flagged, row.names = c("Flag score", "Target counts", "Target counts/cell area", "Cell area in um", "Logged aspect ratio", "Mean DAPI signal"))

kable(poly21, format = "html", col.names = c("Outlier thresholds", "Unflagged cells", "Flagged cells", "% flagged cells"), align = "c", caption = paste0("<center>Flagged cells by different metrics, total cells in whole sample: ", dim(spe$polygons_whole_custom)[1], ", flagged cells in whole sample: ", sum(spe$polygons_whole_custom$outlier_flagscorehw=="red"), " , total cells in mock fov: ", dim(polygons21)[1], "</center>"), padding = 1L)
```
#
#

## Big flag threshold map 

```{r, out.width="150%", out.height="150%"}
plot_list <- list(p1, p2, p3, p4, p5, p6)

for(i in 1:length(plot_list)){
  print(plot_list[[i]])
}
```

# Fov 25 {.tabset .tabset-fade .tabset-pills}

```{r, out.width="150%", out.height="150%"}
polygons25 <- filter(spe$polygons, fov==25)

tm_shape(polygons25) + 
  tm_fill(col= "flag_score_hw", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE)

```

```{r, out.width="300%", out.height="900%"}
p1 <- tm_shape(polygons25) + 
  tm_fill(col= "outlier_flagscorehw", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Flag score outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p2 <- tm_shape(polygons25) + 
  tm_fill(col= "outlier_target", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p3 <- tm_shape(polygons25) + 
  tm_fill(col= "outlier_targetarea", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts/cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p4 <- tm_shape(polygons25) + 
  tm_fill(col= "outlier_umarea", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p5 <- tm_shape(polygons25) + 
  tm_fill(col= "outlier_loghw", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Logged AspectRatio outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p6 <- tm_shape(polygons25) + 
  tm_fill(col= "outlier_dapi", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "DAPI outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))


tmap_arrange(p1, p2, p3, p4, p5, p6, ncol = 2)
```

## Flagged cell stats

```{r, out.width="150%", out.height="150%"}

out_fence <- c(paste(round(attr(spe$outlier_flagscorehw,"thresholds")["lower"], 2), round(attr(spe$outlier_flagscorehw,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_target,"thresholds")["lower"], 2), round(attr(spe$outlier_target,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_targetarea,"thresholds")["lower"], 2), round(attr(spe$outlier_targetarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_umarea,"thresholds")["lower"], 2), round(attr(spe$outlier_umarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_loghw,"thresholds")["lower"], 2), round(attr(spe$outlier_loghw,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_dapi,"thresholds")["lower"], 2), round(attr(spe$outlier_dapi,"thresholds")["higher"], 2)))

flagged_cells <- c(sum(polygons25$outlier_flagscorehw=="red", na.rm = T),
                   sum(polygons25$outlier_target=="red", na.rm = T),
                   sum(polygons25$outlier_targetarea=="red", na.rm = T),
                   sum(polygons25$outlier_umarea=="red",na.rm = T),
                   sum(polygons25$outlier_loghw=="red",na.rm = T),
                   sum(polygons25$outlier_dapi=="red",na.rm = T))

unflagged_cells <- c(sum(polygons25$outlier_flagscorehw=="white", na.rm = T),
                   sum(polygons25$outlier_target=="white", na.rm = T),
                   sum(polygons25$outlier_targetarea=="white", na.rm = T),
                   sum(polygons25$outlier_umarea=="white",na.rm = T),
                   sum(polygons25$outlier_loghw=="white",na.rm = T),
                   sum(polygons25$outlier_dapi=="white",na.rm = T))

percent_flagged <- round(flagged_cells/dim(polygons25)[1]*100, 2)

poly25 <- data.frame(out_fence = out_fence, unflagged_cells = unflagged_cells, flagged_cells = flagged_cells, percent_flagged = percent_flagged, row.names = c("Flag score", "Target counts", "Target counts/cell area", "Cell area in um", "Logged aspect ratio", "Mean DAPI signal"))

kable(poly25, format = "html", col.names = c("Outlier thresholds", "Unflagged cells", "Flagged cells", "% flagged cells"), align = "c", caption = paste0("<center>Flagged cells by different metrics, total cells in whole sample: ", dim(spe$polygons_whole_custom)[1], ", flagged cells in whole sample: ", sum(spe$polygons_whole_custom$outlier_flagscorehw=="red"), " , total cells in mock fov: ", dim(polygons25)[1], "</center>"), padding = 1L)
```
#
#

## Big flag threshold map 

```{r, out.width="150%", out.height="150%"}
plot_list <- list(p1, p2, p3, p4, p5, p6)

for(i in 1:length(plot_list)){
  print(plot_list[[i]])
}
```

# Fov 16 {.tabset .tabset-fade .tabset-pills}

```{r, out.width="150%", out.height="150%"}
polygons16 <- filter(spe$polygons, fov==16)

tm_shape(polygons16) + 
  tm_fill(col= "flag_score_hw", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE)

```

```{r, out.width="300%", out.height="900%"}
p1 <- tm_shape(polygons16) + 
  tm_fill(col= "outlier_flagscorehw", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Flag score outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p2 <- tm_shape(polygons16) + 
  tm_fill(col= "outlier_target", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p3 <- tm_shape(polygons16) + 
  tm_fill(col= "outlier_targetarea", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts/cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p4 <- tm_shape(polygons16) + 
  tm_fill(col= "outlier_umarea", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p5 <- tm_shape(polygons16) + 
  tm_fill(col= "outlier_loghw", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Logged AspectRatio outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p6 <- tm_shape(polygons16) + 
  tm_fill(col= "outlier_dapi", alpha = 0.5) +
  tm_borders(lwd = 0.01, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "DAPI outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))


tmap_arrange(p1, p2, p3, p4, p5, p6, ncol = 2)
```

## Flagged cell stats

```{r, out.width="150%", out.height="150%"}

out_fence <- c(paste(round(attr(spe$outlier_flagscorehw,"thresholds")["lower"], 2), round(attr(spe$outlier_flagscorehw,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_target,"thresholds")["lower"], 2), round(attr(spe$outlier_target,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_targetarea,"thresholds")["lower"], 2), round(attr(spe$outlier_targetarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_umarea,"thresholds")["lower"], 2), round(attr(spe$outlier_umarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_loghw,"thresholds")["lower"], 2), round(attr(spe$outlier_loghw,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_dapi,"thresholds")["lower"], 2), round(attr(spe$outlier_dapi,"thresholds")["higher"], 2)))

flagged_cells <- c(sum(polygons16$outlier_flagscorehw=="red", na.rm = T),
                   sum(polygons16$outlier_target=="red", na.rm = T),
                   sum(polygons16$outlier_targetarea=="red", na.rm = T),
                   sum(polygons16$outlier_umarea=="red",na.rm = T),
                   sum(polygons16$outlier_loghw=="red",na.rm = T),
                   sum(polygons16$outlier_dapi=="red",na.rm = T))

unflagged_cells <- c(sum(polygons16$outlier_flagscorehw=="white", na.rm = T),
                   sum(polygons16$outlier_target=="white", na.rm = T),
                   sum(polygons16$outlier_targetarea=="white", na.rm = T),
                   sum(polygons16$outlier_umarea=="white",na.rm = T),
                   sum(polygons16$outlier_loghw=="white",na.rm = T),
                   sum(polygons16$outlier_dapi=="white",na.rm = T))

percent_flagged <- round(flagged_cells/dim(polygons16)[1]*100, 2)

poly16 <- data.frame(out_fence = out_fence, unflagged_cells = unflagged_cells, flagged_cells = flagged_cells, percent_flagged = percent_flagged, row.names = c("Flag score", "Target counts", "Target counts/cell area", "Cell area in um", "Logged aspect ratio", "Mean DAPI signal"))

kable(poly16, format = "html", col.names = c("Outlier thresholds", "Unflagged cells", "Flagged cells", "% flagged cells"), align = "c", caption = paste0("<center>Flagged cells by different metrics, total cells in whole sample: ", dim(spe$polygons_whole_custom)[1], ", flagged cells in whole sample: ", sum(spe$polygons_whole_custom$outlier_flagscorehw=="red"), " , total cells in mock fov: ", dim(polygons16)[1], "</center>"), padding = 1L)
```
#
#

## Big flag threshold map 

```{r, out.width="150%", out.height="150%"}
plot_list <- list(p1, p2, p3, p4, p5, p6)

for(i in 1:length(plot_list)){
  print(plot_list[[i]])
}
```

