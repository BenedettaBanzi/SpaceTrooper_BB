---
title: "05_29_cosmx_tnbc_02527_custom_mc_focus"
author: "Benedetta Banzi"
date: "2024-06-04"
output: html_document
---

output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

<STYLE TYPE="text/css">
<!--
  td{
    font-family: Arial; 
    font-size: 10 pt;
    padding:0px;
    cellpadding="0";
    cellspacing="0"
  }
  th {
    font-family: Arial; 
    font-size: 10 pt;
    height: 20px;
    font-weight: bold;
    text-align: "center";
    background-color: #ccccff;
    padding-left: 15px;
    padding-right: 15px;
  }
  table { 
    border-spacing: 4px;
    border-collapse: collapse;
  }
--->
</STYLE>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Library import

```{r}
library(SpatialExperiment)
library(data.table)
library(scater) # it imports scuttle
library(cowplot)
library(ggplot2)
theme_set(theme_bw())
library(matrixStats)
library(dplyr)
library(tidyr)
library(tibble)
library(arrow)
library(scales)
library(sf)
library(tmap)
library(knitr)
library(grid)
library(ggpointdensity)
library(ggpubr)
library(spdep)
library(ggExtra)
library(terra)
library(DT)
library(e1071)
library(robustbase)
library(InSituType)
library(UpSetR)
```

Read-in function

```{r}
readCosmxSPE <- function(dirname=dirname,
                        countmatfpattern="exprMat_file.csv",
                        metadatafpattern="metadata_file.csv",
                        coord_names=c("CenterX_global_px", "CenterY_global_px"),
                        polygonsfpattern="polygons.csv",
                        fovposfpattern="fov_positions_file.csv",
                        fov_dims=c(xdim=4256, ydim=4256))
{
    stopifnot(all(names(fov_dims) == c("xdim", "ydim")))
    countmat_file <- list.files(dirname, countmatfpattern, full.names=TRUE)
    metadata_file <- list.files(dirname, metadatafpattern, full.names=TRUE)
    fovpos_file <- list.files(dirname, fovposfpattern, full.names=TRUE)
    pol_file <- list.files(dirname, polygonsfpattern, full.names=TRUE)

    # Read in
    countmat <- data.table::fread(countmat_file) # cell count matrix
    metadata <- data.table::fread(metadata_file) # cell metadata

    # Count matrix
    counts <- merge(countmat, metadata[, c("fov", "cell_ID")])
    cn <- paste0("f", counts$fov, "_c", counts$cell_ID)
    counts <- subset(counts, select = -c(fov, cell_ID))
    # cell_codes <- rownames(counts)
    features <- colnames(counts)
    counts <- t(counts)

    rownames(counts) <- features
    colnames(counts) <- cn

    # rowData (does not exist)
    # To be associated to the tx file
    # use readSparseCSV from harve pege

    # colData
    colData <- DataFrame(merge(metadata, countmat[, c("fov", "cell_ID")]))
    rn <- paste0("f", colData$fov, "_c", colData$cell_ID)
    rownames(colData) <- rn
    ## multiply spatial coordinates in micron multiplying by 0.18 and store
    ## two additional columns depends by technology version

    fov_positions <- as.data.frame(data.table::fread(fovpos_file, header = T))
    names(fov_positions)[names(fov_positions) == "FOV" | names(fov_positions) ==
        "X_px" | names(fov_positions) == "Y_px"] <- c("fov", "x_global_px", 
        "y_global_px")
    ## tracking if one of more fov is not present in the metadata file
    idx <- fov_positions$fov %in% unique(metadata$fov)
    fov_positions <- fov_positions[idx,]
    fov_positions <- fov_positions[order(fov_positions$fov),]
    spe <- SpatialExperiment::SpatialExperiment(
        assays = list(counts = counts),
        # rowData = rowData,
        colData = colData,
        spatialCoordsNames = coord_names,
        metadata=list(fov_positions=fov_positions, fov_dim=fov_dims,
                        polygons=pol_file)
    )
    return(spe)
}
```

Setting directories

```{r}
dirname <- "/data01/Shared/Benedetta/spatial_transcriptomics/CosMx/Datasets/TNBC/UAP7_02527"
sample_name <- "CosMx_human_TNBC_02527"
```

# CosMx dataset preprocessing {.tabset .tabset-fade .tabset-pills}

Data import and SpatialExperiment object creation

```{r}
spe <- readCosmxSPE(dirname = dirname, fov_dims=c(xdim=4256, ydim=4256))
spe <- scuttle::addPerCellQC(spe, subsets=list(NegProb = grep("^Negative", rownames(spe)), SysCtrl = grep("^SystemControl", rownames(spe))))
names(colData(spe)@listData)
spe$control_counts <- rowSums(data.frame(colData(spe))[,grep("^subsets_.*_sum$", names(colData(spe)))])
spe$control_detected <- rowSums(data.frame(colData(spe))[,grep("^subsets_.*_detected$", names(colData(spe)))])
```

Dataset dimensions

```{r}
dim(spe)
```

Adding variables

```{r, class.source = 'fold-show'}
names(colData(spe))[names(colData(spe)) == "cell_id"] <- "cell_id_sample"
names(colData(spe))[names(colData(spe)) == "cell_ID"] <- "cell_id"

spe$fov_id <- paste(spe$fov, spe$cell_id, sep = "_")

# Importing global coordinates from spatialCoords slot since they are not available in colData
# coordinates are retrieved from the slot spe@int_colData@listData$spatialCoords
spe$CenterX_global_px <- spatialCoords(spe)[,1]
spe$CenterY_global_px <- spatialCoords(spe)[,2]

# Converting global coordinates to um 
spe$CenterX_global_um <- spe$CenterX_global_px*0.12
spe$CenterY_global_um <- spe$CenterY_global_px*0.12 

# Logged total counts
spe$logtot <- log10(spe$total)

# Converting area in um
spe$um_area <- spe$Area*0.0144

# Keeping only target counts by subtracting counts referred to control probes
spe$target_counts <- spe$total - spe$control_counts

# Target area ratio
spe$target_area_ratio <- spe$target_counts/spe$um_area

# Logged width/height ratio so there are no holes in the distribution in the middle and also negative values can be appreciated
spe$log2_AspectRatio <- log2(spe$AspectRatio)

# Keeping only detected features by subtracting negative control probes
spe$target_detected <- spe$detected - spe$control_detected

# Proportion between counts referred only to target probes and detected features
spe$tot_det_ratio <- spe$target_counts/spe$target_detected

# Control probe counts/total counts
ctrl_total_ratio <- spe$control_counts/spe$total
ctrl_total_ratio <- replace_na(ctrl_total_ratio, 0)
spe$ctrl_total_ratio <- ctrl_total_ratio
```

Loading custom polygon file and setting the correct format as sf object

Creating custom polygon file to add 

```{r}
metadata <- data.frame(colData(spe))

spat_obj <- fread(file.path(dirname, "UAP7_02527-polygons.csv"))
colnames(spat_obj)[colnames(spat_obj) == "cellID"] <- "cell_id"

sf_global <- st_as_sf(spat_obj, coords = c("x_global_px", "y_global_px"))

polygons_whole_custom <- sf_global %>%
  group_by(fov, cell_id) %>%
  summarize(geometry = st_combine(geometry))#st_combine = combine several feature geometries into one, without unioning or resolving internal boundaries

polygons_whole_custom <- st_cast(polygons_whole_custom, "POLYGON")  

polygons_whole_custom <- polygons_whole_custom[base::order(polygons_whole_custom$fov, polygons_whole_custom$cell_id),]
rownames(polygons_whole_custom) <- paste(polygons_whole_custom$fov, polygons_whole_custom$cell_id, sep = "_")

if(attr(table(rownames(polygons_whole_custom) == colnames(spe)), "dimnames")[[1]][1] == FALSE){
  spe <- spe[, base::order(spe$fov, spe$cell_id)]
  colnames(spe) <- paste(spe$fov, spe$cell_id, sep = "_")
  if(dim(spe)[2] > dim(polygons_whole_custom)[1]){
    spe <- spe[, colnames(spe) %in% rownames(polygons_whole_custom)]
  }
  else{
    polygons_whole_custom <- polygons_whole_custom[rownames(polygons_whole_custom) %in% colnames(spe),]
  }
}

spe$polygons_whole_custom <- polygons_whole_custom
```

# Creating sf using local coordinates for geometry

```{r}
sf_local <- st_as_sf(spat_obj, coords = c("x_local_px", "y_local_px"))
names(sf_local)[names(sf_local) == "cellID"] <- "cell_id"

polygons <- sf_local %>%
  group_by(fov, cell_id) %>%
  summarize(geometry = st_combine(geometry))#st_combine = combine several feature geometries into one, without unioning or resolving internal boundaries

polygons <- st_cast(polygons, "POLYGON")

polygons <- polygons[base::order(polygons$fov, polygons$cell_id),]
rownames(polygons) <- paste(polygons$fov, polygons$cell_id, sep = "_") 

if(attr(table(rownames(polygons) == colnames(spe)), "dimnames")[[1]][1] == FALSE){
  spe <- spe[, base::order(spe$fov, spe$cell_id)]
  colnames(spe) <- paste(spe$fov, spe$cell_id, sep = "_")
  if(dim(spe)[2] > dim(polygons)[1]){
    spe <- spe[, colnames(spe) %in% rownames(polygons)]
  }
  else{
    polygons <- polygons[rownames(polygons) %in% colnames(spe),]
  }
}

spe$polygons <- polygons
```

Checking if the computed polygons are valid and removing elements that could result in geometry errors (Voyager)

```{r}
valid_poly <- st_is_valid(spe$polygons_whole_custom)
table(valid_poly)
```

```{r}
if(attr(table(valid_poly), "dimnames")[[1]][1] == FALSE){
  spe$polygons_whole_custom <- st_buffer(spe$polygons_whole_custom, dist = 0)
}
valid_poly <- st_is_valid(spe$polygons_whole_custom)
table(valid_poly)
```

Checking if all the geometries are polygons

```{r}
table(st_geometry_type(spe$polygons_whole_custom$geometry))
```

Subsetting to remove non-polygons

```{r}
cellids <- c() 
for(i in 1:dim(spe$polygons_whole_custom)[1]){
	cellids[i] <- attr(spe$polygons_whole_custom$geometry[[i]], "class")[2]
	cellids[i] <- cellids[i] == "MULTIPOLYGON"
	
}

spe <- spe[, cellids == FALSE]
table(st_geometry_type(spe$polygons_whole_custom))
```

```{r}
custom_area <- st_area(spe$polygons_whole_custom)
spe$um_area <- custom_area*0.0144
spe$polygons_custom_whole$um_area <- spe$um_area 

AspectRatio <- c()
for(i in 1:dim(spe$polygons_whole_custom)[1]){
 AspectRatio[i] <- (max(spe$polygons_whole_custom$geometry[[i]][[1]][,2]) -     min(spe$polygons_whole_custom$geometry[[i]][[1]][,2]))/(max(spe$polygons_whole_custom$geometry[[i]][[1]][,1]) - min(spe$polygons_whole_custom$geometry[[i]][[1]][,1]))
}

spe$polygons_whole_custom$log2_AspectRatio <- log2(AspectRatio) 
spe$log2_AspectRatio <- log2(AspectRatio) 
```

Checking if local 

```{r}
valid_poly <- st_is_valid(spe$polygons)
table(valid_poly)
```

```{r}
if(attr(table(valid_poly), "dimnames")[[1]][1] == FALSE){
  spe$polygons <- st_buffer(spe$polygons, dist = 0)
}

valid_poly <- st_is_valid(spe$polygons)
table(valid_poly)
```

Checking if all the geometries are polygons

```{r}
table(st_geometry_type(spe$polygons$geometry))
```

# Large-scale to small-scale {.tabset .tabset-fade .tabset-pills}

Approaching dataset preprocessing starting from global-scale, then fov-focused exploratory analysis

## Global sample map

To view the spatial organization of both the sample as it is and FOVs

```{r, out.width="600%", out.height="150%"}
# image theme
global_map_theme <- function(back.color="black",back.border=NA,title.col="white") {
  theme(aspect.ratio = 1,
        panel.border = element_blank(),
        legend.key = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        panel.grid = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "transparent",colour = NA),
        plot.title = element_text(color = title.col,hjust = 0.5,face = "bold"),
        plot.background = element_rect(fill = "transparent",colour = back.border))
}

ggplot() + 
  geom_point(data = metadata, mapping = aes(x = CenterX_global_px, y = CenterY_global_px), colour = "darkmagenta", fill="darkmagenta", size = 0.05, alpha = 0.2) +
  annotate("rect", xmin = metadata(spe)$fov_positions$x_global_px - 1/32*metadata(spe)$fov_dim["xdim"], 
         xmax = metadata(spe)$fov_positions$x_global_px + metadata(spe)$fov_dim["xdim"] - 1/32*metadata(spe)$fov_dim["xdim"], 
         ymin = metadata(spe)$fov_positions$y_global_px - metadata(spe)$fov_dim["ydim"] - 1/16*metadata(spe)$fov_dim["ydim"], 
         ymax = metadata(spe)$fov_positions$y_global_px - 1/16*metadata(spe)$fov_dim["ydim"],
         alpha = .2, color = "black",linewidth = 0.2) +
  geom_text(aes(x = metadata(spe)$fov_positions$x_global_px+11/10*metadata(spe)$fov_dim["xdim"]/2,
                y = metadata(spe)$fov_positions$y_global_px-11/10*metadata(spe)$fov_dim["ydim"]/2,
                label = metadata(spe)$fov_positions$fov), color="black", size = 3) +
  ggtitle(sample_name) +
  global_map_theme(back.color = "white", back.border = "white", title.col = "black")
```

# First cell skimming with constant values {.tabset .tabset-fade .tabset-pills}

Coarse-grain cell filtering to remove gross segmentation errors.
Adding just the variables without plotting

```{r}
spe$flagged_0total <- as.factor(ifelse(colData(spe)$total == 0, TRUE, FALSE))
spe$outlier_ctrl_tot <- ifelse(spe$ctrl_total_ratio > 0.1, TRUE, FALSE) # Voyager
```

# First cell skimming with skewness adjustment to boxplot {.tabset .tabset-fade .tabset-pills}

## Um area

Skewness

```{r}
skewness(spe$um_area)[1]
```

Medcouple

```{r}
mc(spe$um_area)[1]
```

How many outliers were found?

```{r}
names(spe$um_area) <- colnames(spe)
out <- adjbox(spe$um_area)
length(out$out)
area_fence <- out$fence
```

```{r}
outlier_color <- colnames(spe)
for(i in 1:out$n){
  outlier_color[i] <- ifelse(outlier_color[i] %in% names(out$out), "red", "white")
}
spe$mc_umarea_outlier <- ifelse(outlier_color == "red", TRUE, FALSE)
spe$polygons$mc_umarea_outlier <- outlier_color
round(area_fence, 2)
```

## Mean DAPI signal

Skewness

```{r}
skewness(spe$Mean.DAPI)[1]
```

Medcouple

```{r}
mc(spe$Mean.DAPI)[1]
```

How many outliers were found?

```{r}
names(spe$Mean.DAPI) <- colnames(spe)
out <- adjbox(spe$Mean.DAPI)
length(out$out)
dapi_fence <- out$fence
```

```{r}
outlier_color <- colnames(spe)
for(i in 1:out$n)
  outlier_color[i] <- ifelse(outlier_color[i] %in% names(out$out), "red", "white")

spe$mc_dapi_outlier <- ifelse(outlier_color == "red", TRUE, FALSE)
spe$polygons$mc_dapi_outlier <- outlier_color
round(dapi_fence, 2)
```

# First cell skimming with scuttle::isOutlier {.tabset .tabset-fade .tabset-pills}

## um area

```{r}
spe$scuttle_umarea_outlier <- scuttle::isOutlier(colData(spe)$um_area, type = "both")
spe$polygons$scuttle_umarea_outlier <- ifelse(spe$scuttle_umarea_outlier == TRUE, "red", "white")
round(attr(spe$scuttle_umarea_outlier,"thresholds")["lower"], 2)
round(attr(spe$scuttle_umarea_outlier,"thresholds")["higher"], 2)
```

## mean dapi signal

```{r}
spe$scuttle_dapi_outlier <- scuttle::isOutlier(colData(spe)$Mean.DAPI, type = "both")
spe$polygons$scuttle_dapi_outlier <- ifelse(spe$scuttle_dapi_outlier == TRUE, "red", "white")
round(attr(spe$scuttle_dapi_outlier,"thresholds")["lower"], 2)
round(attr(spe$scuttle_dapi_outlier,"thresholds")["higher"], 2)
```


```{r}
out_boundaries <- c(0, 0.1, 
               paste(round(area_fence[1,1], 2), round(area_fence[2,1], 2)),
               paste(round(dapi_fence[1,1], 2), round(dapi_fence[2,1], 2)))

flagged_cells <- c(sum(spe$flagged_0total == TRUE, na.rm = T),
                   sum(spe$outlier_ctrl_tot == TRUE, na.rm = T),
                   paste(sum(spe$um_area < round(area_fence[1,1], 2), na.rm = T), sum(spe$um_area > round(area_fence[2,1], 2), na.rm = T), sep = ", "),
                   paste(sum(spe$Mean.DAPI < round(dapi_fence[1,1], 2),na.rm = T),
                   sum(spe$Mean.DAPI > round(dapi_fence[2,1], 2),na.rm = T), sep = ", "))

unflagged_cells <- c(sum(spe$flagged_0total == FALSE, na.rm = T),
                     sum(spe$outlier_ctrl_tot == FALSE, na.rm = T),
                     sum(spe$mc_umarea_outlier == FALSE,na.rm = T),
                     sum(spe$mc_dapi_outlier == FALSE, na.rm = T))

union_flagged <- length(unique(c(spe[,spe$flagged_0total == TRUE]$fov_id,
                   spe[,spe$outlier_ctrl_tot == TRUE]$fov_id,
                   spe[,spe$mc_umarea_outlier == TRUE]$fov_id,
                   spe[,spe$mc_dapi_outlier == TRUE]$fov_id)))

stat_df <- data.frame(out_boundaries = out_boundaries, unflagged_cells = unflagged_cells, flagged_cells = flagged_cells, row.names = c("Total counts", "Control/total counts ratio", "Cell area in um", "Mean DAPI signal"))

kable(stat_df, format = "html", col.names = c("Outlier boundaries", "Unflagged cells", "Flagged cells"), align = "c", caption = paste0("<center>Flagged cells by different metrics, total cells in whole sample: ", dim(spe$polygons_whole_custom)[1], ", total unique flagged cells in whole sample: ", union_flagged, ", % unique flagged cells: ",
round(union_flagged/dim(spe)[2]*100, 2),"</center>"), padding = 1L)

```


# Plots {.tabset .tabset-fade .tabset-pills}

## um area histogram

```{r}
colors <- c("Medcouple" = "purple4", "MAD" = "tomato")

ggplot(data = data.frame(colData(spe))) +
    geom_histogram(aes(x = um_area), fill = "#81ccbb") +
    geom_vline(aes(xintercept = round(area_fence, 2)[1], color = "Medcouple")) +
    geom_vline(aes(xintercept = round(area_fence, 2)[2], color = "Medcouple")) +
    geom_text(aes(x = round(area_fence, 2)[1], y = 0, label = as.character(round(area_fence, 2)[1])), color = "purple4") +
    geom_text(aes(x = round(area_fence, 2)[2], y = 0, label = as.character(round(area_fence, 2)[2])), color = "purple4") +
    geom_vline(aes(xintercept = round(attr(spe$scuttle_umarea_outlier,"thresholds")["lower"], 2), color = "MAD")) +
    geom_vline(aes(xintercept = round(attr(spe$scuttle_umarea_outlier,"thresholds")["higher"], 2), color = "MAD")) +
    geom_text(aes(x = round(attr(spe$scuttle_umarea_outlier,"thresholds")["lower"], 2), y = 750, label = as.character(round(attr(spe$scuttle_umarea_outlier,"thresholds")["lower"], 2))), color = "tomato") +
    geom_text(aes(x = round(attr(spe$scuttle_umarea_outlier,"thresholds")["higher"], 2), y = 750, label = as.character(round(attr(spe$scuttle_umarea_outlier,"thresholds")["higher"], 2))), color = "tomato") +
    ggtitle("Area in um") +
    labs(color = "Legend") +
    scale_color_manual(values = colors)
```

## dapi histogram

```{r}
ggplot(data = data.frame(colData(spe))) +
    geom_histogram(aes(x = Mean.DAPI), fill = "#81ccbb") +
    geom_vline(aes(xintercept = round(dapi_fence, 2)[1], color = "Medcouple")) +
    geom_vline(aes(xintercept = round(dapi_fence, 2)[2], color = "Medcouple")) +
    geom_text(aes(x = round(dapi_fence, 2)[1], y = 0, label = as.character(round(dapi_fence, 2)[1])), color = "purple4") +
    geom_text(aes(x = round(dapi_fence, 2)[2], y = 0, label = as.character(round(dapi_fence, 2)[2])), color = "purple4") +
    geom_vline(aes(xintercept = round(attr(spe$scuttle_dapi_outlier,"thresholds")["lower"], 2), color = "MAD")) +
    geom_vline(aes(xintercept = round(attr(spe$scuttle_dapi_outlier,"thresholds")["higher"], 2), color = "MAD")) +
    geom_text(aes(x = round(attr(spe$scuttle_dapi_outlier,"thresholds")["lower"], 2), y = 750, label = as.character(round(attr(spe$scuttle_dapi_outlier,"thresholds")["lower"], 2))), color = "tomato") +
    geom_text(aes(x = round(attr(spe$scuttle_dapi_outlier,"thresholds")["higher"], 2), y = 750, label = as.character(round(attr(spe$scuttle_dapi_outlier,"thresholds")["higher"], 2))), color = "tomato") +
    ggtitle("Mean DAPI signal") +
    labs(color = "Legend") +
    scale_color_manual(values = colors)
```

## um area focus on fovs

```{r}
spe$polygons$outlier_fence_color <- case_when(spe$flagged_0total == TRUE ~ "darkturquoise",
                                              spe$outlier_ctrl_tot == TRUE ~ "magenta",
                                           spe$Mean.DAPI > round(dapi_fence[2], 2) ~ "greenyellow",
                                           spe$Mean.DAPI < round(dapi_fence[1], 2) ~ "purple",
                                           spe$um_area > round(area_fence[2], 2) ~ "red",
                                           spe$um_area < round(area_fence[1], 2) ~ "black",
                                           TRUE ~ "white")
```

```{r, out.width="150%", out.height="150%"}
polygons91 <- spe$polygons[spe$fov == 91,]

tm_shape(polygons91) + 
  tm_fill(col = "outlier_fence_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Mc outlier cells in fov 91",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0)) +
    tm_add_legend(col = c("white", "darkturquoise", "magenta", "purple", "greenyellow","black", "red"),
                  labels = c("unflagged cells", "cells with 0 total counts", "cells with ctrl/total ratio > 0.1", "outlier for DAPI lower thr.", "outlier for DAPI higher thr.", "outlier for um area lower thr.","outlier for um area higher thr."))
```

```{r, out.width="150%", out.height="150%"}
polygons146 <- spe$polygons[spe$fov == 146,]

tm_shape(polygons146) + 
  tm_fill(col = "outlier_fence_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Mc outlier cells in fov 146",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0)) +
tm_add_legend(col = c("white", "darkturquoise", "magenta", "purple", "greenyellow","black", "red"),
                  labels = c("unflagged cells", "cells with 0 total counts", "cells with ctrl/total ratio > 0.1", "outlier for DAPI lower thr.", "outlier for DAPI higher thr.", "outlier for um area lower thr.","outlier for um area higher thr."))

```

```{r, out.width="150%", out.height="150%"}
polygons154 <- spe$polygons[spe$fov == 154,]

tm_shape(polygons154) + 
  tm_fill(col = "outlier_fence_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Mc outlier cells in fov 154",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0)) +
    tm_add_legend(col = c("white", "darkturquoise", "magenta", "purple", "greenyellow","black", "red"),
                  labels = c("unflagged cells", "cells with 0 total counts", "cells with ctrl/total ratio > 0.1", "outlier for DAPI lower thr.", "outlier for DAPI higher thr.", "outlier for um area lower thr.","outlier for um area higher thr."))

```

```{r, out.width="150%", out.height="150%"}
polygons138 <- spe$polygons[spe$fov == 138,]

tm_shape(polygons138) + 
  tm_fill(col = "outlier_fence_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Mc outlier cells in fov 138",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0)) +
    tm_add_legend(col = c("white", "darkturquoise", "magenta", "purple", "greenyellow","black", "red"),
                  labels = c("unflagged cells", "cells with 0 total counts", "cells with ctrl/total ratio > 0.1", "outlier for DAPI lower thr.", "outlier for DAPI higher thr.", "outlier for um area lower thr.","outlier for um area higher thr."))

```

```{r, out.width="150%", out.height="150%"}
polygons47 <- spe$polygons[spe$fov == 47,]

tm_shape(polygons47) + 
  tm_fill(col = "outlier_fence_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Mc outlier cells in fov 47",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0)) +
    tm_add_legend(col = c("white", "darkturquoise", "magenta", "purple", "greenyellow","black", "red"),
                  labels = c("unflagged cells", "cells with 0 total counts", "cells with ctrl/total ratio > 0.1", "outlier for DAPI lower thr.", "outlier for DAPI higher thr.", "outlier for um area lower thr.","outlier for um area higher thr."))

```

```{r, out.width="150%", out.height="150%"}
polygons159 <- spe$polygons[spe$fov == 159,]

tm_shape(polygons159) + 
  tm_fill(col = "outlier_fence_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Mc outlier cells in fov 159",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0)) +
    tm_add_legend(col = c("white", "darkturquoise", "magenta", "purple", "greenyellow","black", "red"),
                  labels = c("unflagged cells", "cells with 0 total counts", "cells with ctrl/total ratio > 0.1", "outlier for DAPI lower thr.", "outlier for DAPI higher thr.", "outlier for um area lower thr.","outlier for um area higher thr."))

```

```{r, out.width="150%", out.height="150%"}
polygons52 <- spe$polygons[spe$fov == 52,]

tm_shape(polygons52) + 
  tm_fill(col = "outlier_fence_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Mc outlier cells in fov 52",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0)) +
    tm_add_legend(col = c("white", "darkturquoise", "magenta", "purple", "greenyellow","black", "red"),
                  labels = c("unflagged cells", "cells with 0 total counts", "cells with ctrl/total ratio > 0.1", "outlier for DAPI lower thr.", "outlier for DAPI higher thr.", "outlier for um area lower thr.","outlier for um area higher thr."))

```

```{r, out.width="150%", out.height="150%"}
polygons73 <- spe$polygons[spe$fov == 73,]

tm_shape(polygons73) + 
  tm_fill(col = "outlier_fence_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Mc outlier cells in fov 73",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0)) +
    tm_add_legend(col = c("white", "darkturquoise", "magenta", "purple", "greenyellow","black", "red"),
                  labels = c("unflagged cells", "cells with 0 total counts", "cells with ctrl/total ratio > 0.1", "outlier for DAPI lower thr.", "outlier for DAPI higher thr.", "outlier for um area lower thr.","outlier for um area higher thr."))

```

```{r, out.width="150%", out.height="150%"}
polygons163 <- spe$polygons[spe$fov == 163,]

tm_shape(polygons163) + 
  tm_fill(col = "outlier_fence_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Mc outlier cells in fov 163",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0)) +
    tm_add_legend(col = c("white", "darkturquoise", "magenta", "purple", "greenyellow","black", "red"),
                  labels = c("unflagged cells", "cells with 0 total counts", "cells with ctrl/total ratio > 0.1", "outlier for DAPI lower thr.", "outlier for DAPI higher thr.", "outlier for um area lower thr.","outlier for um area higher thr."))

```
