---
title: "04_03_merfish_mouse_liver1_slice1_report"
author: "Benedetta Banzi"
date: "2024-03-26"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

<STYLE TYPE="text/css">
<!--
  td{
    font-family: Arial; 
    font-size: 10 pt;
    padding:0px;
    cellpadding="0";
    cellspacing="0"
  }
  th {
    font-family: Arial; 
    font-size: 10 pt;
    height: 20px;
    font-weight: bold;
    text-align: "center";
    background-color: #ccccff;
    padding-left: 15px;
    padding-right: 15px;
  }
  table { 
    border-spacing: 4px;
    border-collapse: collapse;
  }
--->
</STYLE>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preliminary steps

Library import

```{r}
library(SpatialExperiment)
library(data.table)
library(scater) # it imports scuttle
library(cowplot)
library(ggplot2)
theme_set(theme_bw())
library(matrixStats)
library(dplyr)
library(tidyr)
library(tibble)
library(arrow)
library(scales)
library(sf)
library(tmap)
library(knitr)
library(grid)
library(ggpointdensity)
library(ggpubr)
library(spdep)
library(ggExtra)
library(DT)
library(e1071)
library(robustbase)
```

Read-in function

```{r}
readMerfishSPE <- function(dirname = dirname, 
                            countmatfpattern = "cell_by_gene.csv", 
                            metadatafpattern = "cell_metadata.csv", 
                            coord_names = c("center_x", "center_y")){

  countmat_file <- file.path(dirname, list.files(dirname, countmatfpattern))
  metadata_file <- file.path(dirname, list.files(dirname, metadatafpattern))

  # Read in 
  countmat <- data.table::fread(countmat_file)
  countmat <- countmat[order(countmat$V1), ]
  
  metadata <- data.table::fread(metadata_file)
  names(metadata)[names(metadata) == "V1"] <- "cell_id"
  metadata <- metadata[order(metadata$cell_id), ]

  # Count matrix 
  rownames(countmat) <- countmat$V1
  counts <- t(subset(countmat, select = - V1))

  # rowData (does not exist)

  # colData
  rownames(metadata) <- metadata$V1
  names(metadata)[names(metadata) == "V1"] <- "cell_id"
  colData <- metadata

  spe <- SpatialExperiment::SpatialExperiment(
    assays = list(counts = counts),
    # rowData = rowData,
    colData = colData,
    spatialCoordsNames = coord_names
  )

  return(spe)

}
```

Setting directories

```{r}
dirname <- "/data01/Shared/Benedetta/spatial_transcriptomics/Vizgen_MERSCOPE/Datasets/LiverMouse1Slice1"
sample_name <- "Merfish_mouse_liver1_slice1"
```

# Merscope dataset exploratory analysis for preprocessing {.tabset .tabset-fade .tabset-pills}

SpatialExperiment object creation and exploration

```{r}
spe <- readMerfishSPE(dirname = dirname)
spe <- scuttle::addPerCellQC(spe, subsets=list(Blank = grep("^Blank-", rownames(spe))))
names(colData(spe)@listData)
spe$control_counts <- spe$subsets_Blank_sum
spe$control_detected <- spe$subsets_Blank_detected
```
Dataset dimensions

```{r}
dim(spe)
```

Loading polygons and checking if the computed polygons are valid and removing elements that could result in geometry errors (Voyager)

```{r}
polygons_whole <- readRDS(file.path(dirname, "polygons.rds"))
names(polygons_whole)[names(polygons_whole) == "cellID"] <- "cell_id"

polygons_whole <- polygons_whole[order(polygons_whole$cell_id), ]

valid_poly <- st_is_valid(polygons_whole)
table(valid_poly)
```

```{r}
table(st_geometry_type(polygons_whole))
```

Calculating area and AspectRatio

```{r}
polygons_whole$cell_area <- st_area(polygons_whole)

AspectRatio <- c()
for(i in 1:dim(polygons_whole)[1]){
 AspectRatio[i] <- (max(polygons_whole$geometry[[i]][[1]][,2]) - min(polygons_whole$geometry[[i]][[1]][,2]))/(max(polygons_whole$geometry[[i]][[1]][,1]) -
 min(polygons_whole$geometry[[i]][[1]][,1]))
}

polygons_whole$log2_AspectRatio <- log2(AspectRatio) 
```

Added variables

```{r}
# Importing global coordinates from spatialCoords slot since they are not available in colData
colData(spe)$CenterX_global_um <- spatialCoords(spe)[,1]
colData(spe)$CenterY_global_um <- spatialCoords(spe)[,2]

# Logged total counts
spe$logtot <- log10(spe$total)

# Cell area in um
spe$cell_area <- polygons_whole$cell_area

# Logged width/height ratio so there are no holes in the distribution in the middle and also negative values can be appreciated
spe$log2_AspectRatio <- polygons_whole$log2_AspectRatio

# Keeping only target counts by subtracting counts referred to negative control probes
spe$target_counts <- spe$total - spe$control_counts

# Keeping only detected features by subtracting negative control probes
spe$target_detected <- spe$detected - spe$control_detected

# Proportion between counts referred only to target probes and detected features
spe$tot_det_ratio <- spe$target_counts/spe$target_detected

# Control probe counts/total counts
ctrl_total_ratio <- spe$control_counts/spe$total
ctrl_total_ratio <- replace_na(ctrl_total_ratio, 0)
spe$ctrl_total_ratio <- ctrl_total_ratio

# Target area ratio
spe$target_area_ratio <- spe$target_counts/spe$cell_area
```

# Large-scale to small-scale {.tabset .tabset-fade .tabset-pills}

Approaching dataset preprocessing starting from global-scale, then fov-focused exploratory analysis

## Global sample map

To view the spatial organization of both the sample as it is 

```{r, out.width="900%", out.height="600%"}
metadata <- data.frame(colData(spe))

tm_shape(polygons_whole)+
  tm_borders(lwd = 0.1, col = "grey50")+
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = sample_name,
            main.title.size = 0.5,
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

## Global feature maps

To spot areas with anomalous feature values and spatial patterns on a global scale

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", colour_by = "total", point_size = 0.1) + ggtitle("Total counts per cell") + theme(aspect.ratio = 1)
```

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", colour_by = "logtot", point_size = 0.1) + ggtitle("Log-total counts per cell") + theme(aspect.ratio = 1)
```

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", colour_by = "detected", point_size = 0.1) + ggtitle("Detected features per cell") + theme(aspect.ratio = 1)
```

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", order_by = "cell_area", colour_by = "cell_area", point_size = 0.1) + ggtitle("Cell area in Î¼m per cell") + theme(aspect.ratio = 1)
```

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", order_by = "log2_AspectRatio", colour_by = "log2_AspectRatio", point_size = 0.1) + ggtitle("Logged width/height ratio per cell") + theme(aspect.ratio = 1)
```

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", colour_by = "tot_det_ratio", point_size = 0.1) + ggtitle("Target counts/detected features ratio per cell") + theme(aspect.ratio = 1)
```

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um", order_by = "control_counts", colour_by = "control_counts", point_size = 0.1) +
  scale_color_gradient(low = "white", high = "red", name = "control_counts") + ggtitle("Negative control probe counts per cell") +
  theme(aspect.ratio = 1,
        panel.background = element_rect(fill = "black",color = NA),
        plot.background = element_rect(fill = "black",color = NA),
        axis.title.x = element_text(color = "white"),
        axis.title.y = element_text(color = "white"),
        axis.ticks = element_line(color = "white"),
        axis.text.y = element_text(color = "white"),
        axis.text.x = element_text(color = "white"),
        axis.line = element_line(color = "white"),
        legend.title = element_text(color = "white"),
        legend.text = element_text(color = "white"),
        plot.title = element_text(color = "white"))
```

```{r, out.width="150%", out.height="150%"}
plotColData(spe, "CenterY_global_um", "CenterX_global_um",  order_by = "ctrl_total_ratio", colour_by = "ctrl_total_ratio", point_size = 0.1) + ggtitle("Control counts/total counts ratio per cell") + theme(aspect.ratio = 1)
```

```{r}
threshold <- 0.20
spe$flagged_tot_20 <- as.factor(ifelse(colData(spe)$total < quantile(colData(spe)$total, probs = threshold), TRUE, FALSE))

threshold <- 0.10
spe$flagged_tot_10 <- as.factor(ifelse(colData(spe)$total < quantile(colData(spe)$total, probs = threshold), TRUE, FALSE))

threshold <- 0.05
spe$flagged_tot_5 <- as.factor(ifelse(colData(spe)$total < quantile(colData(spe)$total, probs = threshold), TRUE, FALSE))

threshold <- 0.10
spe$flagged_det_10 <- as.factor(ifelse(colData(spe)$detected < quantile(colData(spe)$detected, probs = threshold), TRUE, FALSE))

threshold <- 0.05
spe$flagged_det_5 <- as.factor(ifelse(colData(spe)$detected < quantile(colData(spe)$detected, probs = threshold), TRUE, FALSE))

threshold <- 0.10
spe$flagged_cellarea_10 <- as.factor(ifelse(colData(spe)$cell_area < quantile(colData(spe)$cell_area, probs = threshold), TRUE, FALSE))

threshold <- 0.05
spe$flagged_cellarea_5 <- as.factor(ifelse(colData(spe)$cell_area < quantile(colData(spe)$cell_area, probs = threshold), TRUE, FALSE))

threshold <- 0.90
spe$flagged_cellarea_90 <- as.factor(ifelse(colData(spe)$cell_area > quantile(colData(spe)$cell_area, probs = threshold), TRUE, FALSE))

threshold <- 0.95
spe$flagged_cellarea_95 <- as.factor(ifelse(colData(spe)$cell_area > quantile(colData(spe)$cell_area, probs = threshold), TRUE, FALSE))

threshold <- 0.10
spe$flagged_aratio_10 <- as.factor(ifelse(colData(spe)$log2_AspectRatio < quantile(colData(spe)$log2_AspectRatio, probs = threshold), TRUE, FALSE))

threshold <- 0.05
spe$flagged_aratio_5 <- as.factor(ifelse(colData(spe)$log2_AspectRatio < quantile(colData(spe)$log2_AspectRatio, probs = threshold), TRUE, FALSE))

threshold <- 0.90
spe$flagged_aratio_90 <- as.factor(ifelse(colData(spe)$log2_AspectRatio > quantile(colData(spe)$log2_AspectRatio, probs = threshold), TRUE, FALSE))

threshold <- 0.95
spe$flagged_aratio_95 <- as.factor(ifelse(colData(spe)$log2_AspectRatio > quantile(colData(spe)$log2_AspectRatio, probs = threshold), TRUE, FALSE))

threshold <- 0.10
spe$flagged_tdratio_10 <- as.factor(ifelse(colData(spe)$tot_det_ratio < quantile(colData(spe)$tot_det_ratio, probs = threshold, na.rm = T), TRUE, FALSE))

threshold <- 0.05
spe$flagged_tdratio_5 <- as.factor(ifelse(colData(spe)$tot_det_ratio < quantile(colData(spe)$tot_det_ratio, probs = threshold, na.rm = T), TRUE, FALSE))

threshold <- 1
spe$flagged_tdratio_atomx <- as.factor(ifelse(colData(spe)$tot_det_ratio <= threshold, TRUE, FALSE))

threshold <- 0.50
spe$flagged_negprob_50 <- as.factor(ifelse(colData(spe)$control_counts > quantile(colData(spe)$control_counts, probs = threshold, na.rm = T), TRUE, FALSE))

threshold <- 0.75
spe$flagged_negprob_75 <- as.factor(ifelse(colData(spe)$control_counts > quantile(colData(spe)$control_counts, probs = threshold, na.rm = T), TRUE, FALSE))

threshold <- 0.10
spe$flagged_negprob_10 <- as.factor(ifelse(colData(spe)$ctrl_total_ratio > quantile(colData(spe)$ctrl_total_ratio, probs = threshold, na.rm = T), TRUE, FALSE))

threshold <- 0.95
spe$flagged_negprob_95 <- as.factor(ifelse(colData(spe)$control_counts > quantile(colData(spe)$control_counts, probs = threshold, na.rm = T), TRUE, FALSE))

threshold <- 0.99
spe$flagged_negprob_99 <- as.factor(ifelse(colData(spe)$control_counts > quantile(colData(spe)$control_counts, probs = threshold, na.rm = T), TRUE, FALSE))

threshold <- 0.01
spe$flagged_cellarea_1 <- as.factor(ifelse(colData(spe)$cell_area < quantile(colData(spe)$cell_area, probs = threshold), TRUE, FALSE))

threshold <- 0.99
spe$flagged_cellarea_99 <- as.factor(ifelse(colData(spe)$cell_area > quantile(colData(spe)$cell_area, probs = threshold), TRUE, FALSE))

threshold <- 0.01
spe$flagged_target_1 <- as.factor(ifelse(colData(spe)$target_counts < quantile(colData(spe)$target_counts, probs = threshold), TRUE, FALSE))

threshold <- 0.05
spe$flagged_target_5 <- as.factor(ifelse(colData(spe)$target_counts < quantile(colData(spe)$target_counts, probs = threshold), TRUE, FALSE))
```

# Feature histograms 

To check feature distribution before highlighting where extreme values are located in the global sample map

```{r}
variables <- c("total", "detected", "logtot", "cell_area", "tot_det_ratio", "log2_AspectRatio","control_counts", "ctrl_total_ratio")
for (var in 1:length(variables)){
  n <- grep(paste0("^", variables[var], "$"), colnames(spe@colData))
  histo_var <- names(colData(spe))[n]
  p <- ggplot(data = data.frame(colData(spe))) +
    geom_histogram(aes(x = .data[[histo_var]]), fill = "#69b3a2") +
    ggtitle(paste0(histo_var))
  print(p)
}  
```

# First cell skimming with absolute values {.tabset .tabset-fade .tabset-pills}

Coarse-grain cell filtering to remove gross segmentation errors.

## Total counts

```{r}
summary(spe$total)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$total)
```

```{r, out.width="150%", out.height="150%"}
boxplot(spe$total)
```

```{r, out.width="150%", out.height="150%"}
threshold <- 0
spe$flagged_0total <- as.factor(ifelse(colData(spe)$total == 0, TRUE, FALSE))
polygons_whole$flagged_0total <- ifelse(spe$flagged_0total == TRUE, "red", "grey80")

tm_shape(polygons_whole) + 
  tm_fill(col= "flagged_0total") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Cells having 0 total counts", "\nFlagged cells = ",
                                table(colData(spe)$flagged_0total)["TRUE"], " out of ", dim(spe)[2], ", ",
                                round(table(colData(spe)$flagged_0total)["TRUE"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

```{r}
tot0_spe <- spe[,spe$flagged_0total == FALSE]
dim(tot0_spe)
```

# First cell skimming with quantile thresholds {.tabset .tabset-fade .tabset-pills}

## Control probes

```{r}
summary(spe$control_counts)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$control_counts)
```

```{r, out.width="150%", out.height="150%"}
boxplot(spe$control_counts)
```


```{r, out.width="150%", out.height="150%"}
threshold <- 0.99
spe$flagged_negprob_99 <- as.factor(ifelse(colData(spe)$control_counts > quantile(colData(spe)$control_counts, probs = threshold, na.rm = T), TRUE, FALSE))
polygons_whole$flagged_negprob_99 <- ifelse(spe$flagged_negprob_99 == TRUE, "red", "grey80")

tm_shape(polygons_whole) + 
  tm_fill(col= "flagged_negprob_99") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Negative probe counts above 99% threshold, value = ", 
                                round(quantile(colData(spe)$control_counts, probs = threshold, na.rm = T), 2), "\nFlagged cells = ",
                                table(colData(spe)$flagged_negprob_99)["TRUE"], " out of ", dim(spe)[2], ", ",
                                round(table(colData(spe)$flagged_negprob_99)["TRUE"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

```{r}
negprob_spe <- spe[,spe$flagged_negprob_99 == FALSE]
summary(negprob_spe$control_counts)
```

```{r, out.width="150%", out.height="150%"}
hist(negprob_spe$control_counts)
```

```{r, out.width="150%", out.height="150%"}
boxplot(negprob_spe$control_counts)
```

## Control count / total count

```{r}
summary(spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
boxplot(spe$ctrl_total_ratio)
```


```{r, out.width="150%", out.height="150%"}
threshold <- 0.99
spe$flagged_ctrl_tot_ratio_99 <- as.factor(ifelse(colData(spe)$ctrl_total_ratio > quantile(colData(spe)$ctrl_total_ratio, probs = threshold, na.rm = T), TRUE, FALSE))
polygons_whole$flagged_ctrl_tot_ratio_99 <- ifelse(spe$flagged_ctrl_tot_ratio_99 == TRUE, "red", "grey80")

tm_shape(polygons_whole) + 
  tm_fill(col= "flagged_ctrl_tot_ratio_99") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Control / total counts ratio above 99% threshold, value = ", 
                                round(quantile(colData(spe)$ctrl_total_ratio, probs = threshold, na.rm = T), 2), "\nFlagged cells = ",
                                table(colData(spe)$flagged_ctrl_tot_ratio_99)["TRUE"], " out of ", dim(spe)[2], ", ",
                                round(table(colData(spe)$flagged_ctrl_tot_ratio_99)["TRUE"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

```{r}
ctrltotratio_spe <- spe[,spe$flagged_ctrl_tot_ratio_99 == FALSE]
summary(ctrltotratio_spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
hist(ctrltotratio_spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
boxplot(ctrltotratio_spe$ctrl_total_ratio)
```


## Cell area, low threshold

```{r}
summary(spe$cell_area)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$cell_area)
```

```{r, out.width="150%", out.height="150%"}
boxplot(spe$cell_area)
```

```{r, out.width="150%", out.height="150%"}
threshold <- 0.01
spe$flagged_cellarea_1 <- as.factor(ifelse(colData(spe)$cell_area < quantile(colData(spe)$cell_area, probs = threshold), TRUE, FALSE))
plotColData(spe, "CenterY_global_um", "CenterX_global_um", colour_by = "flagged_cellarea_1", 
            point_size = 0.1) + scale_color_manual(values = c("TRUE" = "black","FALSE" = "lightgrey")) + ggtitle(paste0("Cell area in Î¼m below 1%, threshold value = ", round(quantile(colData(spe)$cell_area, probs = threshold, na.rm = T), 2)))  + theme(legend.position="none") + labs(subtitle = paste0("Flagged cells = ", table(colData(spe)$flagged_cellarea_1)["TRUE"], " out of ", dim(spe)[2], ", ",  round(table(colData(spe)$flagged_cellarea_1)["TRUE"]/dim(spe)[2]*100, 2), "% of total cells"))
```


```{r, out.width="150%", out.height="150%"}
threshold <- 0.01
spe$flagged_target_1 <- as.factor(ifelse(colData(spe)$target_counts < quantile(colData(spe)$target_counts, probs = threshold), TRUE, FALSE))

plotColData(spe, "CenterY_global_um", "CenterX_global_um", colour_by = "flagged_target_1", 
            point_size = 0.1) + scale_color_manual(values = c("TRUE" = "black","FALSE" = "lightgrey")) + ggtitle(paste0("Target counts below 1%, threshold value = ", round(quantile(colData(spe)$target_counts, probs = threshold, na.rm = T), 2)))  + theme(legend.position="none") + labs(subtitle = paste0("Flagged cells = ", table(colData(spe)$flagged_target_1)["TRUE"], " out of ", dim(spe)[2], ", ",  round(table(colData(spe)$flagged_target_1)["TRUE"]/dim(spe)[2]*100, 2), "% of total cells"))
```

```{r}
threshold <- 0.01
spe$flagged_target_1 <- as.factor(ifelse(colData(spe)$target_counts < quantile(colData(spe)$target_counts, probs = threshold), TRUE, FALSE))
# to remove small cells that also have a number of target counts below 1%
table(spe$flagged_cellarea_1, spe$flagged_target_1, dnn = c("flagged_cellarea_1", "flagged_target_1"))
```

## Cell area, high threshold

```{r, out.width="150%", out.height="150%"}
threshold <- 0.99
spe$flagged_cellarea_99 <- as.factor(ifelse(colData(spe)$cell_area > quantile(colData(spe)$cell_area, probs = threshold), TRUE, FALSE))
polygons_whole$flagged_cellarea_99 <- ifelse(spe$flagged_cellarea_99 == TRUE, "red", "grey80")

tm_shape(polygons_whole) + 
  tm_fill(col= "flagged_cellarea_99") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Cell area in um above 99% threshold, threshold value = ", 
                                round(quantile(colData(spe)$cell_area, probs = threshold, na.rm = T), 2), "\nFlagged cells = ",
                                table(colData(spe)$flagged_cellarea_99)["TRUE"], " out of ", dim(spe)[2], ", ",
                                round(table(colData(spe)$flagged_cellarea_99)["TRUE"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

```{r}
# Big problematic cells we noticed in polygons map can be captured using both negative probe counts and area above 90%
table(spe$flagged_negprob_99, spe$flagged_cellarea_99, dnn = c("flagged_negprob_99", "flagged_cellarea_99,"))
```

```{r}
area_spe <- spe[, spe$flagged_cellarea_99 == FALSE & spe$flagged_cellarea_1 == FALSE]
summary(area_spe$cell_area)
```

```{r, out.width="150%", out.height="150%"}
hist(area_spe$cell_area)
```

```{r, out.width="150%", out.height="150%"}
boxplot(area_spe$cell_area)
```


## Logged AspectRatio, low threshold

```{r}
summary(spe$log2_AspectRatio)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$log2_AspectRatio)
```

```{r, out.width="150%", out.height="150%"}
boxplot(spe$log2_AspectRatio)
```

```{r, out.width="150%", out.height="150%"}
threshold <- 0.01
spe$flagged_logAspectRatio_1 <- as.factor(ifelse(spe$log2_AspectRatio < quantile(spe$log2_AspectRatio, probs = threshold, na.rm = T), TRUE, FALSE))
polygons_whole$flagged_logAspectRatio_1 <- ifelse(spe$flagged_logAspectRatio_1 == TRUE, "black", "grey80")

tm_shape(polygons_whole) + 
  tm_fill(col= "flagged_logAspectRatio_1") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Logged AspectRatio below 1% threshold, threshold value = ", 
                                round(quantile(colData(spe)$log2_AspectRatio, probs = threshold, na.rm = T), 2), "\nFlagged cells = ",
                                table(colData(spe)$flagged_logAspectRatio_1)["TRUE"], " out of ", dim(spe)[2], ", ",
                                round(table(colData(spe)$flagged_logAspectRatio_1)["TRUE"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

## Logged AspectRatio, high threshold

```{r, out.width="150%", out.height="150%"}
threshold <- 0.99
spe$flagged_logAspectRatio_99 <- as.factor(ifelse(spe$log2_AspectRatio > quantile(spe$log2_AspectRatio, probs = threshold, na.rm = T), TRUE, FALSE))
polygons_whole$flagged_logAspectRatio_99 <- ifelse(spe$flagged_logAspectRatio_99 == TRUE, "red", "grey80")

tm_shape(polygons_whole) + 
  tm_fill(col= "flagged_logAspectRatio_99") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Logged AspectRatio above 99% threshold, threshold value = ", 
                                round(quantile(colData(spe)$log2_AspectRatio, probs = threshold, na.rm = T), 2), "\nFlagged cells = ",
                                table(colData(spe)$flagged_logAspectRatio_99)["TRUE"], " out of ", dim(spe)[2], ", ",
                                round(table(colData(spe)$flagged_logAspectRatio_99)["TRUE"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

```{r}
aspectratio_spe <- spe[, spe$flagged_logAspectRatio_99 == FALSE & spe$flagged_logAspectRatio_1 == FALSE]
summary(aspectratio_spe$log2_AspectRatio)
```

```{r, out.width="150%", out.height="150%"}
hist(aspectratio_spe$log2_AspectRatio)
```

```{r, out.width="150%", out.height="150%"}
boxplot(aspectratio_spe$log2_AspectRatio)
```


# First cell skimming with scuttle::isOutlier (Hampel filter) {.tabset .tabset-fade .tabset-pills}

Introducing scuttle::isOutlier function to move to a different filter beyond threshold
Outliers are defined when their value is higher or lower than the median, plus or minus 3 median absolute deviations (MAD) respectively.
However, when using MAD a symmetric distribution is assumed

## Control counts

```{r}
summary(spe$control_counts)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$control_counts)
```

```{r, out.width="150%", out.height="150%"}
boxplot(spe$control_counts)
```

```{r, out.width="150%", out.height="150%"}
spe$outlier_negprob <- scuttle::isOutlier(spe$control_counts, type = "higher")
polygons_whole$outlier_negprob <- ifelse(spe$outlier_negprob == TRUE, "red", "grey80")

tm_shape(polygons_whole) + 
  tm_fill(col= "outlier_negprob") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Outlier cells for negative probe counts", 
                                "\n lower thr. = " , round(attr(spe$outlier_negprob,"thresholds")["lower"], 2), ", higher thr. = ",
                                round(attr(spe$outlier_negprob,"thresholds")["higher"], 2),
                                "\nFlagged cells = ",
                                table(colData(spe)$outlier_negprob)["TRUE"], " out of ", dim(spe)[2], ", ",
                                round(table(colData(spe)$outlier_negprob)["TRUE"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

```

```{r}
negprob_spe <- spe[,spe$outlier_negprob == FALSE]
summary(negprob_spe$control_counts)
```

```{r, out.width="150%", out.height="150%"}
hist(negprob_spe$control_counts)
```

```{r, out.width="150%", out.height="150%"}
boxplot(negprob_spe$control_counts)
```

## Control count / total counts

```{r}
summary(spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
boxplot(spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
spe$outlier_ctrl_tot <- scuttle::isOutlier(spe$ctrl_total_ratio, type = "higher")
polygons_whole$outlier_ctrl_tot <- ifelse(spe$outlier_ctrl_tot == TRUE, "red", "grey80")

tm_shape(polygons_whole) + 
  tm_fill(col= "outlier_ctrl_tot") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Outlier cells for control / total counts ratio", 
                                "\n lower thr. = " , round(attr(spe$outlier_ctrl_tot,"thresholds")["lower"], 2), ", higher thr. = ",
                                round(attr(spe$outlier_ctrl_tot,"thresholds")["higher"], 2),
                                "\nFlagged cells = ",
                                table(colData(spe)$outlier_ctrl_tot)["TRUE"], " out of ", dim(spe)[2], ", ",
                                round(table(colData(spe)$outlier_ctrl_tot)["TRUE"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

```

```{r}
ctrltotratio_spe <- spe[,spe$outlier_ctrl_tot == FALSE]
summary(ctrltotratio_spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
hist(ctrltotratio_spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
boxplot(ctrltotratio_spe$ctrl_total_ratio)
```

## Cell area

```{r}
summary(spe$cell_area)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$cell_area)
```

```{r, out.width="150%", out.height="150%"}
boxplot(spe$cell_area)
```

```{r, out.width="150%", out.height="150%"}
spe$outlier_cellarea <- scuttle::isOutlier(colData(spe)$cell_area, type = "both")
polygons_whole$outlier_cellarea <- ifelse(spe$outlier_cellarea == TRUE, "red", "grey80")

tm_shape(polygons_whole) + 
  tm_fill(col= "outlier_cellarea") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Outlier cells for cell area", 
                                "\n lower thr. = " , round(attr(spe$outlier_cellarea,"thresholds")["lower"], 2), ", higher thr. = ",
                                round(attr(spe$outlier_cellarea,"thresholds")["higher"], 2),
                                "\nFlagged cells = ",
                                table(colData(spe)$outlier_cellarea)["TRUE"], " out of ", dim(spe)[2], ", ",
                                round(table(colData(spe)$outlier_cellarea)["TRUE"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

```{r}
area_spe <- spe[, spe$outlier_cellarea == FALSE]
summary(area_spe$cell_area)
```

```{r, out.width="150%", out.height="150%"}
hist(area_spe$cell_area)
```

```{r, out.width="150%", out.height="150%"}
boxplot(area_spe$cell_area)
```


## Log2 AspectRatio

```{r}
summary(spe$log2_AspectRatio)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$log2_AspectRatio)
```

```{r, out.width="150%", out.height="150%"}
boxplot(spe$log2_AspectRatio)
```

```{r, out.width="150%", out.height="150%"}
spe$outlier_loghw <- scuttle::isOutlier(spe$log2_AspectRatio, type = "both")
polygons_whole$outlier_loghw<- ifelse(spe$outlier_loghw == TRUE, "red", "grey80")

tm_shape(polygons_whole) + 
  tm_fill(col= "outlier_loghw") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Outlier cells for logged aspect ratio",
                                "\n lower thr. = " , round(attr(spe$outlier_loghw,"thresholds")["lower"],2), ", higher thr. = ",
                                round(attr(spe$outlier_loghw,"thresholds")["higher"], 2),
                                "\nFlagged cells = ",
                                table(colData(spe)$outlier_loghw)["TRUE"], " out of ", dim(spe)[2], ", ",
                                round(table(colData(spe)$outlier_loghw)["TRUE"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

```{r}
attr(spe$outlier_loghw, "threshold")
```

```{r}
loghw_spe <- spe[, spe$outlier_loghw == FALSE]
summary(loghw_spe$log2_AspectRatio)
```

```{r, out.width="150%", out.height="150%"}
hist(loghw_spe$log2_AspectRatio)
```

```{r, out.width="150%", out.height="150%"}
boxplot(loghw_spe$log2_AspectRatio)
```


# First cell skimming with skewness adjustment to boxplot {.tabset .tabset-fade .tabset-pills}

Introducing medcouple (MC) from Hubert, M. and Vandervieren, E. (2008). Boxplot whiskers are defined as:
1st quartile - 1.5 * hl(MC) * IQR 
3rd quartile + 1.5 * hu(MC) * IQR
If MC >= 0, hl = exp(-4 * MC), hu = exp(3 * MC) 
If MC < 0, hl = exp(-3 * MC), hu = exp(4 * MC)

```{r}
polygons_whole$control_counts <- spe$control_counts
polygons_whole$cell_area <- spe$cell_area
```

## Control counts

```{r}
summary(spe$control_counts)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$control_counts)
```

A normal distribution should have a skewness of 0.

```{r}
#it should be 0
library(e1071)
skewness(spe$control_counts, na.rm = T)[1]
```

â0.6 â¤ MC â¤ 0.6 is requested by Hubert and Vandervieren (2008) for their adjusted boxplot.

```{r}
library(robustbase)
mc(spe$control_counts, na.rm = T)[1] 
```

How many outliers were found?

```{r}
names(spe$control_counts) <- spe$cell_id
out <- adjbox(spe$control_counts)
ctrlcounts_fence <- out$fence
length(out$out)
```

Distribution of outlier values

```{r}
summary(out$out)
```

```{r, out.width="150%", out.height="150%"}
outlier_color <- spe$cell_id
for(i in 1:dim(spe)[2])
  outlier_color[i] <- ifelse(outlier_color[i] %in% names(out$out), "red", "grey80")

polygons_whole$ctrlcounts_outlier <- outlier_color

tm_shape(polygons_whole) + 
  tm_fill(col = "ctrlcounts_outlier") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Outlier cells for control counts", 
                                "\n fence = " , round(out$fence, 2),
                                "\nFlagged cells = ",
                                table(polygons_whole$ctrlcounts_outlier)["red"], " out of ", dim(spe)[2], ", ",
                                round(table(polygons_whole$ctrlcounts_outlier)["red"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

```{r}
ctrlcounts_poly <- polygons_whole[polygons_whole$ctrlcounts_outlier == "grey80",]
hist(ctrlcounts_poly$control_counts)
```

```{r, out.width="150%", out.height="150%"}
boxplot(ctrlcounts_poly$control_counts)
```

```{r}
summary(ctrlcounts_poly$control_counts)
```

## Control / total counts ratio

```{r}
summary(spe$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$ctrl_total_ratio)
```

```{r}
skewness(spe$ctrl_total_ratio, na.rm = T)[1]
```

```{r}
mc(spe$ctrl_total_ratio, na.rm = T)[1] 
```

How many outliers were found?

```{r}
names(spe$ctrl_total_ratio) <- spe$cell_id
out <- adjbox(spe$ctrl_total_ratio)
ctrltot_fence <- out$fence
length(out$out)
```

Distribution of outlier values

```{r}
summary(out$out)
```

```{r, out.width="150%", out.height="150%"}
outlier_color <- spe$cell_id
for(i in 1:dim(spe)[2])
  outlier_color[i] <- ifelse(outlier_color[i] %in% names(out$out), "red", "grey80")

polygons_whole$ctrltot_outlier <- outlier_color

tm_shape(polygons_whole) + 
  tm_fill(col= "ctrltot_outlier") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Outlier cells for control total counts ratio", "\n fence = " , round(out$fence, 2),
                                "\nFlagged cells = ",
                                table(polygons_whole$ctrltot_outlier)["red"], " out of ", dim(spe)[2], ", ",
                                round(table(polygons_whole$ctrltot_outlier)["red"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

```{r}
polygons_whole$ctrl_total_ratio <- spe$ctrl_total_ratio
ctrltot_poly <- polygons_whole[polygons_whole$ctrltot_outlier == "grey80",]
hist(ctrltot_poly$ctrl_total_ratio)
```

```{r, out.width="150%", out.height="150%"}
boxplot(ctrltot_poly$ctrl_total_ratio)
```

```{r}
summary(ctrltot_poly$ctrl_total_ratio)
```

## Cell area

```{r}
summary(spe$cell_area)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$cell_area)
```

Skewness

```{r}
skewness(spe$cell_area)[1]
```

Medcouple

```{r}
mc(spe$cell_area)[1]
```

How many outliers were found?

```{r}
names(spe$cell_area) <- spe$cell_id
out <- adjbox(spe$cell_area)
cellarea_fence <- out$fence
length(out$out)
```

Distribution of outlier values

```{r}
summary(out$out)
```

```{r, out.width="150%", out.height="150%"}
outlier_color <- spe$cell_id
for(i in 1:out$n){
  outlier_color[i] <- ifelse(outlier_color[i] %in% names(out$out), "red", "grey80")
}

polygons_whole$cellarea_outlier <- outlier_color

tm_shape(polygons_whole) + 
  tm_fill(col= "cellarea_outlier") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Outlier cells for cell_area", 
                                "\n fence = " , round(out$fence, 2),
                                "\nFlagged cells = ",
                                table(polygons_whole$cellarea_outlier)["red"], " out of ", dim(spe)[2], ", ",
                                round(table(polygons_whole$cellarea_outlier)["red"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

```{r}
area_poly <- polygons_whole[polygons_whole$cellarea_outlier == "grey80",]
hist(area_poly$cell_area)
```

```{r, out.width="150%", out.height="150%"}
boxplot(area_poly$cell_area)
```

```{r}
summary(area_poly$cell_area)
```


## Log2 AspectRatio

```{r}
summary(spe$log2_AspectRatio)
```

```{r, out.width="150%", out.height="150%"}
hist(spe$log2_AspectRatio)
```

Skewness

```{r}
skewness(spe$log2_AspectRatio, na.rm = TRUE)[1]
```

Medcouple

```{r}
mc(spe$log2_AspectRatio, na.rm = TRUE)[1]
```

How many outliers were found?

```{r}
names(spe$log2_AspectRatio) <- spe$cell_id
out <- adjbox(spe$log2_AspectRatio)
loghw_fence <- out$fence 
length(out$out)
```

Distribution of outlier values

```{r}
summary(out$out)
```

```{r, out.width="150%", out.height="150%"}
outlier_color <- spe$cell_id
for(i in 1:dim(spe)[2])
  outlier_color[i] <- ifelse(outlier_color[i] %in% names(out$out), "red", "grey80")

polygons_whole$loghw_outlier <- outlier_color

tm_shape(polygons_whole) + 
  tm_fill(col= "loghw_outlier") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = paste0("Outlier cells for logged aspect ratio", 
                                "\n fence = " , round(out$fence, 2),
                                "\nFlagged cells = ",
                                table(polygons_whole$loghw_outlier)["red"], " out of ", dim(spe)[2], ", ",
                                round(table(polygons_whole$loghw_outlier)["red"]/dim(spe)[2]*100, 2), "% of total cells"),
            main.title.fontface = 2,
            main.title.size = 1, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))
```

```{r}
loghw_poly <- polygons_whole[polygons_whole$loghw_outlier == "grey80",]
hist(loghw_poly$log2_AspectRatio)
```

```{r, out.width="150%", out.height="150%"}
boxplot(loghw_poly$log2_AspectRatio)
```

```{r}
summary(loghw_poly$log2_AspectRatio)
```

# Flag score development 

## Exploratory scatterplots {.tabset .tabset-fade .tabset-pills}

### Total counts ~ cell area

```{r, out.width="150%", out.height="150%"}
cell_df <- data.frame(colData(spe))

p <- ggplot(data = cell_df) +
  geom_pointdensity(aes(x = cell_area, y = total)) +
  scale_color_viridis_c() +
  theme(legend.position = "none",
        plot.margin = margin())

ggMarginal(p, type = "density", color = "#ccccff", fill = "#ccccff") 
```

### Cell area ~ global coordinates on X axis in px

```{r, out.width="150%", out.height="150%"}
p <- ggplot(data = cell_df) +
  geom_pointdensity(aes(x = CenterX_global_um, y = cell_area)) +
  scale_color_viridis_c() +
  theme(legend.position = "none",
        plot.margin = margin())

ggMarginal(p, type = "density", color = "#ccccff", fill = "#ccccff") 
```

### Cell area ~ global coordinates on Y axis in px

```{r, out.width="150%", out.height="150%"}
p <- ggplot(data = cell_df) +
  geom_pointdensity(aes(x = CenterY_global_um, y = cell_area)) +
  scale_color_viridis_c() +
  theme(legend.position = "none",
        plot.margin = margin())

ggMarginal(p, type = "density", color = "#ccccff", fill = "#ccccff") 
```

### Cell area ~ control counts

```{r, out.width="150%", out.height="150%"}
p <- ggplot(data = cell_df) +
  geom_pointdensity(aes(x = control_counts, y = cell_area)) +
  scale_color_viridis_c() +
  theme(legend.position = "none",
        plot.margin = margin())

ggMarginal(p, type = "density", color = "#ccccff", fill = "#ccccff") 
```

### Global coordinates on X axis ~ logged AspectRatio

```{r, out.width="150%", out.height="150%"}
p <- ggplot(data = cell_df) +
  geom_pointdensity(aes(x = CenterX_global_um, y = log2_AspectRatio)) +
  scale_color_viridis_c() +
  theme(legend.position = "none",
        plot.margin = margin())

ggMarginal(p, type = "density", color = "#ccccff", fill = "#ccccff") 
```

### Global coordinates on Y axis ~ logged AspectRatio

```{r, out.width="150%", out.height="150%"}
p <- ggplot(data = cell_df) +
  geom_pointdensity(aes(x = CenterY_global_um, y = log2_AspectRatio)) +
  scale_color_viridis_c() +
  theme(legend.position = "none",
        plot.margin = margin())

ggMarginal(p, type = "density", color = "#ccccff", fill = "#ccccff") 
```


```{r, out.width="150%", out.height="150%"}
polygons_whole$total <- spe$total
polygons_whole$target_counts <- spe$target_counts
polygons_whole$control_counts <- spe$control_counts
polygons_whole$target_area_ratio <- spe$target_area_ratio
polygons_whole$cell_area <- spe$cell_area
```

```{r, out.width="150%", out.height="150%"}
spe$flag_score_hw <- 1/(1 + exp(-0.4*spe$target_counts/spe$cell_area + 0.4*abs(spe$log2_AspectRatio)))
summary(spe$flag_score_hw)

polygons_whole$flag_score_hw <- spe$flag_score_hw

tm_shape(polygons_whole) + 
  tm_fill(col = "flag_score_hw") +
  tm_layout(legend.outside = TRUE)
```

# Flag threshold map with AspectRatio in flag score formula and scuttle outliers {.tabset .tabset-fade .tabset-pills}

```{r}
spe$outlier_target <- scuttle::isOutlier(spe$target_counts, type = "lower", nmad = 0.5)
polygons_whole$outlier_target <- ifelse(spe$outlier_target == TRUE, "red", "grey80")

spe$outlier_targetarea <- scuttle::isOutlier(spe$target_area_ratio, type = "lower", nmad = 0.5)
polygons_whole$outlier_targetarea <- ifelse(spe$outlier_targetarea == TRUE, "red", "grey80")

spe$outlier_cellarea <- scuttle::isOutlier(colData(spe)$cell_area, type = "both")
polygons_whole$outlier_cellarea <- ifelse(spe$outlier_cellarea == TRUE, "red", "grey80")

spe$outlier_loghw <- scuttle::isOutlier(spe$log2_AspectRatio, type = "both")
polygons_whole$outlier_loghw<- ifelse(spe$outlier_loghw == TRUE, "red", "grey80")

spe$outlier_flagscorehw <- scuttle::isOutlier(spe$flag_score_hw, type = "lower", nmad = 2)
polygons_whole$outlier_flagscorehw <- ifelse(spe$outlier_flagscorehw == TRUE, "red", "grey80")
```


```{r, out.width="300%", out.height="900%"}
p1 <- tm_shape(polygons_whole) + 
  tm_fill(col= "outlier_flagscorehw", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Flag score outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p2 <- tm_shape(polygons_whole) + 
  tm_fill(col= "outlier_target", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p3 <- tm_shape(polygons_whole) + 
  tm_fill(col= "outlier_targetarea", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts/cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p4 <- tm_shape(polygons_whole) + 
  tm_fill(col= "outlier_cellarea", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p5 <- tm_shape(polygons_whole) + 
  tm_fill(col= "outlier_loghw", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Logged AspectRatio outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

tmap_arrange(p1, p2, p3, p4, p5, ncol = 2)
```

## Flagged cell stats

```{r, out.width="150%", out.height="150%"}

out_fence <- c(paste(round(attr(spe$outlier_flagscorehw,"thresholds")["lower"], 2), round(attr(spe$outlier_flagscorehw,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_target,"thresholds")["lower"], 2), round(attr(spe$outlier_target,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_targetarea,"thresholds")["lower"], 2), round(attr(spe$outlier_targetarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_cellarea,"thresholds")["lower"], 2), round(attr(spe$outlier_cellarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_loghw,"thresholds")["lower"], 2), round(attr(spe$outlier_loghw,"thresholds")["higher"], 2)))

flagged_cells <- c(sum(polygons_whole$outlier_flagscorehw=="red", na.rm = T),
                   sum(polygons_whole$outlier_target=="red", na.rm = T),
                   sum(polygons_whole$outlier_targetarea=="red", na.rm = T),
                   sum(polygons_whole$outlier_cellarea=="red",na.rm = T),
                   sum(polygons_whole$outlier_loghw=="red",na.rm = T))

unflagged_cells <- c(sum(polygons_whole$outlier_flagscorehw=="grey80", na.rm = T),
                   sum(polygons_whole$outlier_target=="grey80", na.rm = T),
                   sum(polygons_whole$outlier_targetarea=="grey80", na.rm = T),
                   sum(polygons_whole$outlier_cellarea=="grey80",na.rm = T),
                   sum(polygons_whole$outlier_loghw=="grey80",na.rm = T))

percent_flagged <- round(flagged_cells/dim(polygons_whole)[1]*100, 2)

poly <- data.frame(out_fence = out_fence, unflagged_cells = unflagged_cells, flagged_cells = flagged_cells, percent_flagged = percent_flagged, row.names = c("Flag score", "Target counts", "Target counts/cell area", "Cell area in um", "Logged aspect ratio"))

kable(poly, format = "html", col.names = c("Outlier thresholds", "Unflagged cells", "Flagged cells", "% flagged cells"), align = "c", caption = paste0("<center>Flagged cells by different metrics, total cells in whole sample: ", dim(polygons_whole)[1], ", flagged cells in whole sample: ", sum(polygons_whole$flagscore_outlier=="red"), "</center>"), padding = 1L)
```
#
#

## Big flag threshold map 

```{r, out.width="150%", out.height="150%"}
plot_list <- list(p1, p2, p3, p4, p5)

for(i in 1:length(plot_list)){
  print(plot_list[[i]])
}
```

# Flag threshold map with AspectRatio in flag score formula and thresholds {.tabset .tabset-fade .tabset-pills}

```{r, out.width="300%", out.height="900%"}
metric_color <- ifelse(polygons_whole$flag_score_hw < quantile(spe$flag_score_hw, probs = 0.01), "red", "grey80")
target_color <- ifelse(polygons_whole$target_counts < quantile(spe$target_counts, probs = 0.15), "red", "grey80")
count_area_ratio_color <- ifelse(polygons_whole$target_area_ratio < quantile(spe$target_area_ratio, probs = 0.15), "red", "grey80")
area_color_lo <- ifelse(polygons_whole$cell_area < quantile(spe$cell_area, probs = 0.15), "red", "grey80")
area_color_hi <- ifelse(polygons_whole$cell_area > quantile(spe$cell_area, probs = 0.85), "red", "grey80")
log_hw_color_lo <- ifelse(polygons_whole$log2_AspectRatio < quantile(spe$log2_AspectRatio, probs = 0.15), "red", "grey80")
log_hw_color_hi <- ifelse(polygons_whole$log2_AspectRatio > quantile(spe$log2_AspectRatio, probs = 0.85), "red", "grey80")

polygons_whole <- cbind(polygons_whole, metric_color = metric_color, target_color = target_color, count_area_ratio_color = count_area_ratio_color, area_color_lo = area_color_lo, area_color_hi = area_color_hi,  log_hw_color_lo = log_hw_color_lo, log_hw_color_hi = log_hw_color_hi)

p1 <- tm_shape(polygons_whole) + 
  tm_fill(col= "metric_color", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Flag score below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p2 <- tm_shape(polygons_whole) + 
  tm_fill(col= "target_color", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p3 <- tm_shape(polygons_whole) + 
  tm_fill(col= "count_area_ratio_color", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts/custom um area below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p4 <- tm_shape(polygons_whole) + 
  tm_fill(col= "area_color_lo", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Cell area below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p5 <- tm_shape(polygons_whole) + 
  tm_fill(col= "area_color_hi", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Cell area above 85th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p6 <- tm_shape(polygons_whole) + 
  tm_fill(col= "log_hw_color_lo", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Logged AspectRatio below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p7 <- tm_shape(polygons_whole) + 
  tm_fill(col= "log_hw_color_hi", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Logged AspectRatio above 85th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

tmap_arrange(p1, p2, p3, p4, p5, p6, p7, ncol = 2)
```

```{r, out.width="150%", out.height="150%"}

flag_value <- c(round(quantile(polygons_whole$flag_score_hw, probs = 0.05), 2),
                round(quantile(polygons_whole$target_counts, probs = 0.15), 2),
                round(quantile((polygons_whole$target_area_ratio), probs = 0.15), 2),
                round(quantile(polygons_whole$cell_area, probs = 0.15), 2),
                round(quantile(polygons_whole$cell_area, probs = 0.85), 2),
                round(quantile(polygons_whole$log2_AspectRatio, probs = 0.15), 2),
                round(quantile(polygons_whole$log2_AspectRatio, probs = 0.85), 2))

flagged_cells <- c(sum(polygons_whole$metric_color=="red", na.rm = T),
                   sum(polygons_whole$target_color=="red", na.rm = T),
                   sum(polygons_whole$count_area_ratio_color=="red", na.rm = T),
                   sum(polygons_whole$area_color_lo=="red", na.rm = T),
                   sum(polygons_whole$area_color_hi=="red", na.rm = T),
                   sum(polygons_whole$log_hw_color_lo=="red", na.rm = T),
                   sum(polygons_whole$log_hw_color_hi=="red", na.rm = T))

unflagged_cells <- c(sum(polygons_whole$metric_color=="grey80", na.rm = T),
                   sum(polygons_whole$target_color=="grey80", na.rm = T),
                   sum(polygons_whole$count_area_ratio_color=="grey80", na.rm = T),
                   sum(polygons_whole$area_color_lo=="grey80", na.rm = T),
                   sum(polygons_whole$area_color_hi=="grey80", na.rm = T),
                   sum(polygons_whole$log_hw_color_lo=="grey80", na.rm = T),
                   sum(polygons_whole$log_hw_color_hi=="grey80", na.rm = T))

percent_flagged <- round(flagged_cells/dim(polygons_whole)[1]*100, 2)

poly <- data.frame(threshold = c(0.01, 0.15, 0.15, 0.15, 0.85, 0.15, 0.85), flag_value = flag_value, unflagged_cells = unflagged_cells, flagged_cells = flagged_cells, percent_flagged = percent_flagged, row.names = c("Flag score", "Target counts", "Target counts/cell area", "Cell area in um low", "Cell area in um high", "Logged aspect ratio low", "Logged aspect ratio high"))

kable(poly, format = "html", col.names = c("Threshold", "Flag value", "Unflagged cells", "Flagged cells", "% flagged cells"), align = "c", caption = paste0("<center>Flagged cells by different metrics, total cells in whole sample: ", dim(polygons_whole)[1], ", flagged cells in whole sample: ", sum(spe$flag_score_hw < quantile(spe$flag_score_hw, probs = 0.15, na.rm = T)), "</center>"), padding = 1L)
```

#
#

## Big flag threshold map 

```{r, out.width="150%", out.height="150%"}
plot_list <- list(p1, p2, p3, p4, p5, p6, p7)

for(i in 1:length(plot_list)){
  print(plot_list[[i]])
}
```

```{r}
polygons_whole <- polygons_whole[sort(polygons_whole$cell_id),]
spe$fov <- spe$fov + 1
polygons_whole$fov <- spe$fov
```

```{r, out.width="900%", out.height="450%"}
palette <- c("gray11", "gray47","blue","royalblue1","dodgerblue4","deepskyblue","cyan","lightblue1","darkseagreen1","darkolivegreen1","limegreen",
"green3","darkgreen","yellow4","yellow","greenyellow","olivedrab1","seagreen2","lightyellow","goldenrod4","goldenrod1","lightgoldenrod1","lightgoldenrod4",	"darkorange1","plum1","orchid4","orchid1","lightpink","lightcoral","orangered1","deeppink1","darkmagenta","red4")

fov_colors <- c()
for(i in 1:dim(polygons_whole)[1]){
   ifelse(polygons_whole$fov[i] %in% c(1:length(palette)), palette[24], "white")
}

polygons_whole$fov_color <- ifelse(polygons_whole$fov %in% 1:length(palette), palette[polygons_whole$fov], "white")

tm_shape(polygons_whole) + 
  tm_fill(col = "fov_color") +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE)
```

# Fov 1 {.tabset .tabset-fade .tabset-pills}

```{r, out.width="150%", out.height="150%"}
polygons1 <- filter(polygons_whole, fov == 1) 

tm_shape(polygons1) + 
  tm_fill(col= "flag_score_hw", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE)
```

```{r, out.width="300%", out.height="900%"}
p1 <- tm_shape(polygons1) + 
  tm_fill(col= "outlier_flagscorehw", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Flag score outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p2 <- tm_shape(polygons1) + 
  tm_fill(col= "outlier_target", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p3 <- tm_shape(polygons1) + 
  tm_fill(col= "outlier_targetarea", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts/cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p4 <- tm_shape(polygons1) + 
  tm_fill(col= "outlier_cellarea", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p5 <- tm_shape(polygons1) + 
  tm_fill(col= "outlier_loghw", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Logged AspectRatio outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

tmap_arrange(p1, p2, p3, p4, p5, ncol = 2)
```

## Flagged cell stats

```{r, out.width="150%", out.height="150%"}

out_fence <- c(paste(round(attr(spe$outlier_flagscorehw,"thresholds")["lower"], 2), round(attr(spe$outlier_flagscorehw,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_target,"thresholds")["lower"], 2), round(attr(spe$outlier_target,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_targetarea,"thresholds")["lower"], 2), round(attr(spe$outlier_targetarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_cellarea,"thresholds")["lower"], 2), round(attr(spe$outlier_cellarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_loghw,"thresholds")["lower"], 2), round(attr(spe$outlier_loghw,"thresholds")["higher"], 2)))

flagged_cells <- c(sum(polygons1$outlier_flagscorehw=="red", na.rm = T),
                   sum(polygons1$outlier_target=="red", na.rm = T),
                   sum(polygons1$outlier_targetarea=="red", na.rm = T),
                   sum(polygons1$outlier_cellarea=="red",na.rm = T),
                   sum(polygons1$outlier_loghw=="red",na.rm = T))

unflagged_cells <- c(sum(polygons1$outlier_flagscorehw=="grey80", na.rm = T),
                   sum(polygons1$outlier_target=="grey80", na.rm = T),
                   sum(polygons1$outlier_targetarea=="grey80", na.rm = T),
                   sum(polygons1$outlier_cellarea=="grey80",na.rm = T),
                   sum(polygons1$outlier_loghw=="grey80",na.rm = T))

percent_flagged <- round(flagged_cells/dim(polygons1)[1]*100, 2)

poly1 <- data.frame(out_fence = out_fence, unflagged_cells = unflagged_cells, flagged_cells = flagged_cells, percent_flagged = percent_flagged, row.names = c("Flag score", "Target counts", "Target counts/cell area", "Cell area in um", "Logged aspect ratio"))

kable(poly1, format = "html", col.names = c("Outlier thresholds", "Unflagged cells", "Flagged cells", "% flagged cells"), align = "c", caption = paste0("<center>Flagged cells by different metrics, total cells in whole sample: ", dim(polygons_whole)[1], ", flagged cells in whole sample: ", sum(polygons_whole$outlier_flagscorehw=="red"), " , total cells in mock fov: ", dim(polygons1)[1], "</center>"), padding = 1L)
```
#
#

## Big flag threshold map 

```{r, out.width="150%", out.height="150%"}
plot_list <- list(p1, p2, p3, p4, p5)

for(i in 1:length(plot_list)){
  print(plot_list[[i]])
}
```


## Flag threshold map

```{r, out.width="300%", out.height="900%"}
metric_color <- ifelse(polygons1$flag_score_hw < quantile(spe$flag_score_hw, probs = 0.15), "red", "white")
target_color <- ifelse(polygons1$target_counts < quantile(spe$target_counts, probs = 0.15), "red", "white")
count_area_ratio_color <- ifelse((polygons1$target_area_ratio) < quantile((spe$target_area_ratio), probs = 0.15), "red", "white")
area_color_lo <- ifelse(polygons1$cell_area < quantile(spe$cell_area, probs = 0.15), "red", "white")
area_color_hi <- ifelse(polygons1$cell_area > quantile(spe$cell_area, probs = 0.85), "red", "white")
log_hw_color_lo <- ifelse(polygons1$log2_AspectRatio < quantile(spe$log2_AspectRatio, probs = 0.15), "red", "white")
log_hw_color_hi <- ifelse(polygons1$log2_AspectRatio > quantile(spe$log2_AspectRatio, probs = 0.85), "red", "white")

polygons1 <- cbind(polygons1, metric_color = metric_color, target_color = target_color, count_area_ratio_color = count_area_ratio_color, area_color_lo = area_color_lo, area_color_hi = area_color_hi, log_hw_color_lo = log_hw_color_lo, log_hw_color_hi = log_hw_color_hi)

p1 <- tm_shape(polygons1) + 
  tm_fill(col= "metric_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Flag score below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p2 <- tm_shape(polygons1) + 
  tm_fill(col= "target_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p3 <- tm_shape(polygons1) + 
  tm_fill(col= "count_area_ratio_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts/custom um area below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p4 <- tm_shape(polygons1) + 
  tm_fill(col= "area_color_lo", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Custom cell area below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p5 <- tm_shape(polygons1) + 
  tm_fill(col= "area_color_hi", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Custom cell area above 85th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p6 <- tm_shape(polygons1) + 
  tm_fill(col= "log_hw_color_lo", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Logged AspectRatio below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p7 <- tm_shape(polygons1) + 
  tm_fill(col= "log_hw_color_hi", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Logged AspectRatio above 85th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

tmap_arrange(p1, p2, p3, p4, p5, p6, p7, ncol = 2)
```

## Flagged cell stats 

```{r, out.width="300%", out.height="300%"}

flagged_cells <- c(sum(polygons1$metric_color=="red", na.rm = T),
                   sum(polygons1$target_color=="red", na.rm = T),
                   sum(polygons1$count_area_ratio_color=="red", na.rm = T),
                   sum(polygons1$area_color_lo=="red", na.rm = T),
                   sum(polygons1$area_color_hi=="red", na.rm = T),
                   sum(polygons1$log_hw_color_lo=="red", na.rm = T),
                   sum(polygons1$log_hw_color_hi=="red", na.rm = T))

unflagged_cells <- c(sum(polygons1$metric_color=="white", na.rm = T),
                     sum(polygons1$target_color=="white", na.rm = T),
                     sum(polygons1$count_area_ratio_color=="white", na.rm = T),
                     sum(polygons1$area_color_lo=="white", na.rm = T),
                     sum(polygons1$area_color_hi=="white", na.rm = T),
                     sum(polygons1$log_hw_color_lo=="white", na.rm = T),
                     sum(polygons1$log_hw_color_hi=="white", na.rm = T))

percent_flagged <- round(flagged_cells/dim(polygons1)[1]*100, 2)

poly1 <- data.frame(threshold = c(0.01, 0.15, 0.15, 0.15, 0.85, 0.15, 0.85), flag_value = flag_value, unflagged_cells = unflagged_cells, flagged_cells = flagged_cells, percent_flagged = percent_flagged, row.names = c("Flag score", "Target counts", "Target counts/um area", "Custom area in um low", "Custom area in um high", "Logged aspect ratio low", "Logged aspect ratio high"))

kable(poly1, format = "html", col.names = c("Threshold", "Flag value", "Unflagged cells", "Flagged cells", "% flagged cells"), align = "c", caption = paste0("<center>Flagged cells by different metrics, total cells in fov: ", dim(polygons1)[1], ", total cells in whole sample: ", dim(polygons_whole)[1], ", flagged cells in whole sample: ", sum(spe$flag_score_hw < quantile(spe$flag_score_hw, probs = 0.15, na.rm = T)), "</center>"), padding = 1L)
```

#
#

## Big threshold map

```{r, out.width="150%", out.height="150%"}
plot_list <- list(p1, p2, p3, p4, p5, p6, p7)

for(i in 1:length(plot_list)){
  print(plot_list[[i]])
}
```


# Fov 1346 {.tabset .tabset-fade .tabset-pills}

```{r, out.width="150%", out.height="150%"}
polygons1346 <- filter(polygons_whole, fov==1346)

tm_shape(polygons1346) + 
  tm_fill(col= "flag_score_hw", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE)

```

```{r, out.width="300%", out.height="900%"}
p1 <- tm_shape(polygons1346) + 
  tm_fill(col= "outlier_flagscorehw", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Flag score outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p2 <- tm_shape(polygons1346) + 
  tm_fill(col= "outlier_target", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p3 <- tm_shape(polygons1346) + 
  tm_fill(col= "outlier_targetarea", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts/cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p4 <- tm_shape(polygons1346) + 
  tm_fill(col= "outlier_cellarea", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Cell area outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p5 <- tm_shape(polygons1346) + 
  tm_fill(col= "outlier_loghw", alpha = 0.5) +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Logged AspectRatio outliers",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

tmap_arrange(p1, p2, p3, p4, p5, ncol = 2)
```

## Flagged cell stats

```{r, out.width="150%", out.height="150%"}

out_fence <- c(paste(round(attr(spe$outlier_flagscorehw,"thresholds")["lower"], 2), round(attr(spe$outlier_flagscorehw,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_target,"thresholds")["lower"], 2), round(attr(spe$outlier_target,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_targetarea,"thresholds")["lower"], 2), round(attr(spe$outlier_targetarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_cellarea,"thresholds")["lower"], 2), round(attr(spe$outlier_cellarea,"thresholds")["higher"], 2)),
               paste(round(attr(spe$outlier_loghw,"thresholds")["lower"], 2), round(attr(spe$outlier_loghw,"thresholds")["higher"], 2)))

flagged_cells <- c(sum(polygons1346$outlier_flagscorehw=="red", na.rm = T),
                   sum(polygons1346$outlier_target=="red", na.rm = T),
                   sum(polygons1346$outlier_targetarea=="red", na.rm = T),
                   sum(polygons1346$outlier_cellarea=="red",na.rm = T),
                   sum(polygons1346$outlier_loghw=="red",na.rm = T))

unflagged_cells <- c(sum(polygons1346$outlier_flagscorehw=="grey80", na.rm = T),
                   sum(polygons1346$outlier_target=="grey80", na.rm = T),
                   sum(polygons1346$outlier_targetarea=="grey80", na.rm = T),
                   sum(polygons1346$outlier_cellarea=="grey80",na.rm = T),
                   sum(polygons1346$outlier_loghw=="grey80",na.rm = T))

percent_flagged <- round(flagged_cells/dim(polygons1346)[1]*100, 2)

poly1346 <- data.frame(out_fence = out_fence, unflagged_cells = unflagged_cells, flagged_cells = flagged_cells, percent_flagged = percent_flagged, row.names = c("Flag score", "Target counts", "Target counts/cell area", "Cell area in um", "Logged aspect ratio"))

kable(poly1346, format = "html", col.names = c("Outlier thresholds", "Unflagged cells", "Flagged cells", "% flagged cells"), align = "c", caption = paste0("<center>Flagged cells by different metrics, total cells in whole sample: ", dim(polygons_whole)[1], ", flagged cells in whole sample: ", sum(polygons_whole$outlier_flagscorehw=="red"), " , total cells in mock fov: ", dim(polygons1346)[1], "</center>"), padding = 1L)
```
#
#

## Big flag threshold map 

```{r, out.width="150%", out.height="150%"}
plot_list <- list(p1, p2, p3, p4, p5)

for(i in 1:length(plot_list)){
  print(plot_list[[i]])
}
```

## Flag threshold map

```{r, out.width="300%", out.height="900%"}
metric_color <- ifelse(polygons1346$flag_score_hw < quantile(spe$flag_score_hw, probs = 0.15), "red", "white")
target_color <- ifelse(polygons1346$target_counts < quantile(spe$target_counts, probs = 0.15), "red", "white")
count_area_ratio_color <- ifelse(polygons1346$target_area_ratio < quantile(spe$target_area_ratio, probs = 0.15), "red", "white")
area_color_lo <- ifelse(polygons1346$cell_area < quantile(spe$cell_area, probs = 0.15), "red", "white")
area_color_hi <- ifelse(polygons1346$cell_area > quantile(spe$cell_area, probs = 0.85), "red", "white")
log_hw_color_lo <- ifelse(polygons1346$log2_AspectRatio < quantile(spe$log2_AspectRatio, probs = 0.15), "red", "white")
log_hw_color_hi <- ifelse(polygons1346$log2_AspectRatio > quantile(spe$log2_AspectRatio, probs = 0.90), "red", "white")

polygons1346 <- cbind(polygons1346, metric_color = metric_color, target_color = target_color, count_area_ratio_color = count_area_ratio_color, area_color_lo = area_color_lo, area_color_hi = area_color_hi, log_hw_color_lo = log_hw_color_lo, log_hw_color_hi = log_hw_color_hi)

p1 <- tm_shape(polygons1346) + 
  tm_fill(col= "metric_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Flag score below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p2 <- tm_shape(polygons1346) + 
  tm_fill(col= "target_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p3 <- tm_shape(polygons1346) + 
  tm_fill(col= "count_area_ratio_color", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Target counts/custom um area below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p4 <- tm_shape(polygons1346) + 
  tm_fill(col= "area_color_lo", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Custom cell area below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p5 <- tm_shape(polygons1346) + 
  tm_fill(col= "area_color_hi", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Custom cell area above 85th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p6 <- tm_shape(polygons1346) + 
  tm_fill(col= "log_hw_color_lo", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Logged AspectRatio below 15th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

p7 <- tm_shape(polygons1346) + 
  tm_fill(col= "log_hw_color_hi", alpha = 0.5) +
  tm_borders(lwd = 0.1, col = "grey50") +
  tm_layout(legend.outside = TRUE,
            main.title.position = c("center", "top"),
            main.title = "Logged AspectRatio above 85th percentile",
            main.title.size = 0.5, 
            inner.margins = c(0, 0, 0, 0),
            outer.margins = c(0, 0, 0, 0))

tmap_arrange(p1, p2, p3, p4, p5, p6, p7, ncol = 2)
```

## Flagged cell stats

```{r, out.width="150%", out.height="150%"}

flagged_cells <- c(sum(polygons1346$metric_color=="red", na.rm = T),
                   sum(polygons1346$target_color=="red", na.rm = T),
                   sum(polygons1346$count_area_ratio_color=="red", na.rm = T),
                   sum(polygons1346$area_color_lo=="red", na.rm = T),
                   sum(polygons1346$area_color_hi=="red", na.rm = T),
                   sum(polygons1346$log_hw_color_lo=="red", na.rm = T),
                   sum(polygons1346$log_hw_color_hi=="red", na.rm = T))

unflagged_cells <- c(sum(polygons1346$metric_color=="white", na.rm = T),
                     sum(polygons1346$target_color=="white", na.rm = T),
                     sum(polygons1346$count_area_ratio_color=="white", na.rm = T),
                     sum(polygons1346$area_color_lo=="white", na.rm = T),
                     sum(polygons1346$area_color_hi=="white", na.rm = T),
                     sum(polygons1346$log_hw_color_lo=="white", na.rm = T),
                     sum(polygons1346$log_hw_color_hi=="white", na.rm = T))

percent_flagged <- round(flagged_cells/dim(polygons1346)[1]*100, 2)

poly1346 <- data.frame(threshold = c(0.15, 0.15, 0.15, 0.15, 0.85, 0.15, 0.85), flag_value = flag_value, unflagged_cells = unflagged_cells, flagged_cells = flagged_cells, percent_flagged = percent_flagged, row.names = c("Flag score", "Target counts", "Target counts/um area", "Custom area in um low", "Custom area in um high", "Logged aspect ratio low", "Logged aspect ratio high"))


kable(poly1346, format = "html", col.names = c("Threshold", "Flag value", "Unflagged cells", "Flagged cells", "% flagged cells"), align = "c", caption = paste0("<center>Flagged cells by different metrics, total cells in fov: ", dim(polygons1346)[1], ", total cells in whole sample: ", dim(polygons_whole)[1], ", flagged cells in whole sample: ", sum(spe$flag_score_hw < quantile(spe$flag_score_hw, probs = 0.15, na.rm = T)), "</center>"), padding = 1L)
```

#
#

## Big flag threshold map

```{r, out.width="150%", out.height="150%"}
plot_list <- list(p1, p2, p3, p4, p5, p6, p7)

for(i in 1:length(plot_list)){
  print(plot_list[[i]])
}
```


