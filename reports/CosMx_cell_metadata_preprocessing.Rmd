---
title: "CosMx_dataset_cell_metadata_preprocessing"
author: "Benedetta Banzi"
date: "2023-12-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warnings = FALSE,
                      messages = FALSE)
```

Library import

```{r}
library(SpatialExperiment)
library(data.table)
library(scater) # it imports scuttle
library(cowplot)
library(ggplot2)
theme_set(theme_bw())
library(matrixStats)
library(dplyr)
library(tidyr)
library(tibble)
library(arrow)
library(scales)
library(sf)
library(tmap)
```

Read-in function

```{r}
readCosmxSPE <- function(dirname = dirname, 
                         countmatfpattern = "exprMat_file.csv", 
                         metadatafpattern = "metadata_file.csv", 
                         coord_names = c("CenterX_global_px",
                                         "CenterY_global_px")){
  
  countmat_file <- file.path(dirname, list.files(dirname, countmatfpattern))
  metadata_file <- file.path(dirname, list.files(dirname, metadatafpattern))
  
  # Read in 
  countmat <- data.table::fread(countmat_file)
  metadata <- data.table::fread(metadata_file)
  
  # Count matrix   
  counts <- merge(countmat, metadata[, c("fov", "cell_ID")])
  counts <- subset(counts, select = -c(fov, cell_ID))
  cell_codes <- rownames(counts)
  features <- colnames(counts)
  counts <- t(counts)
  
  rownames(counts) <- features
  colnames(counts) <- cell_codes
  
  # rowData (does not exist)
  
  # colData
  colData <- merge(metadata, countmat[, c("fov", "cell_ID")])
  
  spe <- SpatialExperiment::SpatialExperiment(
    assays = list(counts = counts),
    # rowData = rowData,
    colData = colData,
    spatialCoordsNames = coord_names
  )
  
  return(spe)
}
```

Setting directories

```{r}
dirname <- "./coronal hippocampus and cortex"
count_pattern <- "Run5642_S3_Quarter_exprMat_file.csv"
meta_pattern <- "Run5642_S3_Quarter_metadata_file.csv"
sample_name <- "mouse_hippo_ctx"
out_dir <- "mouse_hippo_ctx"
dir.create(out_dir)
```

## CosMx dataset exploratory analysis for preprocessing

SpatialExperiment object creation and exploration

```{r}
spe <- readCosmxSPE(dirname = dirname, countmatfpattern = count_pattern, metadatafpattern = meta_pattern)
spe <- scuttle::addPerCellQC(spe, subsets=list(NegProb = grep("^NegPrb", rownames(spe))))
names(colData(spe)@listData)
```

```{r}
dim(spe)
```

Selecting only numeric and integer variables from metadata then only variables of interest from the list

```{r}
temp <- unlist(lapply(spe@colData@listData, function(x) is.numeric(x) | is.integer(x)))
num_variables <- c()
for (i in 1:length(temp)){
  num_variables[i] <- ifelse(temp[i] == TRUE, names(temp[i]), NA)
  num_variables <- num_variables[!is.na(num_variables)]
}
num_variables
variables <- c("total", "detected")
```

## Large-scale to small-scale

Approaching dataset preprocessing starting from global-scale, proceeding to local-scale, then fov-focused exploratory analysis

Sample map with fov grid

```{r}
fov_pattern <- "Run5642_S3_Quarter_fov_positions_file.csv"
metadata_file <- file.path(dirname, list.files(dirname, meta_pattern))
fovpos_file <- file.path(dirname, list.files(dirname, fov_pattern))


metadata <- data.table::fread(metadata_file)
fov_positions <- data.table::fread(fovpos_file, header = T)
fov_positions <- fov_positions[fov_positions$fov%in%unique(metadata$fov),]

# image theme
my_image_theme <- function(back.color="black",back.border=NA,title.col="white") {
  theme(panel.border = element_blank(),
        legend.key = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        panel.grid = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "transparent",colour = NA),
        plot.title = element_text(color = title.col,hjust = 0.5,face = "bold"),
        plot.background = element_rect(fill = "transparent",colour = back.border))
}

fov_xdim <- 4256
fov_ydim <- 4256
# pdf(file.path(out_dir,"firstplot.pdf"))
ggplot() + 
  geom_point(data = metadata, mapping = aes(x = CenterX_global_px, y = CenterY_global_px), colour = "darkmagenta", fill="darkmagenta", size = 0.05, alpha = 0.2) +
  annotate("rect", xmin = fov_positions$x_global_px, 
           xmax = fov_positions$x_global_px + fov_xdim, 
           ymin = fov_positions$y_global_px, 
           ymax = fov_positions$y_global_px + fov_ydim,
           alpha = .2, color = "black",linewidth = 0.2) +
  geom_text(aes(x = fov_positions$x_global_px+fov_xdim/2,
                y = fov_positions$y_global_px+fov_ydim/2,
                label = fov_positions$fov), color="black", fontface = "bold") +
  ggtitle(sample_name) + 
  my_image_theme(back.color = "white", back.border = "white", title.col = "black")
# dev.off()
```

Numeric/integer variable dependence on global position

Importing global coordinates from spatialCoords slot since they are not available in colData

```{r}
colData(spe)$CenterX_global_px <- spatialCoords(spe)[,1]
colData(spe)$CenterY_global_px <- spatialCoords(spe)[,2]
```

Global coordinate scatterplot colored by variables showing spatial pattern in boxplots

```{r}
spe$logtot <- log10(spe$total)
spe$logdet <- log10(spe$detected)

plotColData(spe, "CenterY_global_px", "CenterX_global_px", colour_by = "total", point_size = 0.1) + ggtitle("Total counts per cell")
```

```{r}
plotColData(spe, "CenterY_global_px", "CenterX_global_px", colour_by = "logtot", point_size = 0.1) + ggtitle("Log-total counts per cell")
```

```{r}
plotColData(spe, "CenterY_global_px", "CenterX_global_px", colour_by = "detected", point_size = 0.1) + ggtitle("Detected features per cell")
```

```{r}
plotColData(spe, "CenterY_global_px", "CenterX_global_px", colour_by = "logdet", point_size = 0.1) + ggtitle("Log-detected features per cell")
```

```{r}
plotColData(spe, "CenterY_global_px", "CenterX_global_px", colour_by = "Area", point_size = 0.1) + ggtitle("Area")
```

```{r}
plotColData(spe, "CenterY_global_px", "CenterX_global_px", colour_by = "AspectRatio", point_size = 0.1) + ggtitle("Aspect ratio")
```


Focusing on scRNA-seq-specific variables and area ~ global coordinates

```{r}
p1 <- plotColData(spe, "total", "CenterX_global_px")
p2 <- plotColData(spe, "total", "CenterY_global_px")
p3 <- plotColData(spe, "detected", "CenterX_global_px")
p4 <- plotColData(spe, "detected", "CenterY_global_px")
plot_grid(p1, p2, p3, p4, ncol = 2)
```

```{r}
p1 <- plotColData(spe, "logtot", "CenterX_global_px")
p2 <- plotColData(spe, "logtot", "CenterY_global_px")
p3 <- plotColData(spe, "Area", "CenterX_global_px")
p4 <- plotColData(spe, "Area", "CenterY_global_px")
plot_grid(p1, p2, p3, p4, ncol = 2)
```

## Check dependence on fov

Boxplot of each of the numeric/integer variable distribution by fov, useful to see spatial patterns in data

```{r, warnings = FALSE}
variables <- c(variables, "logtot", "logdet", "Area", "AspectRatio")

for (var in 1:length(variables)){
  n <- grep(paste0("^", variables[var], "$"), colnames(spe@colData))
  boxplot(spe@colData@listData[[n]] ~ spe$fov, ylab = colnames(spe@colData)[n], cex = 0.2)
  title(paste0(colnames(spe@colData)[n], "~fov"))
}
```

Per fov cell counts

```{r}
fov_df <- data.frame("n_cells" = as.integer(table(spe@colData@listData$fov)), "fov" = as.factor(names(table(spe@colData@listData$fov))))
levels(fov_df$fov) <- order(levels(fov_df$fov), seq(1:length(fov_df$fov)))

ggplot(data = fov_df, aes(x = fov, y = n_cells)) +
  geom_col(fill = "#B0C4DE") + theme(legend.position ="none") +
  ggtitle("Number of cells per fov") 
```

Total/Area scatterplot

```{r}
cell_df <- as.data.frame(spe@colData@listData)

ggplot(data = cell_df, aes(x = Area, y = total)) +
  geom_point() + 
  ggtitle("Counts per cell and cell area ratio")
```

Detected/Area scatterplot

```{r}
ggplot(data = cell_df, aes(x = Area, y = detected)) +
  geom_point() + 
  ggtitle("Features per cell and cell area ratio")
```

Total/Area scatterplot faceted by fov

```{r}
cell_df <- as.data.frame(spe@colData@listData)

ggplot(data = cell_df, aes(x = Area, y = total)) +
  geom_point() +
  facet_wrap(~fov) + 
  ggtitle("Counts per cell and cell area ratio faceted by fov")
```

Detected/Area scatterplot faceted by fov

```{r}
ggplot(data = cell_df, aes(x = Area, y = detected)) +
  geom_point() +
  facet_wrap(~fov) + 
  ggtitle("Features per cell and cell area ratio faceted by fov")
```









